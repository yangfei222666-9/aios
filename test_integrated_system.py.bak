#!/usr/bin/env python3
"""
é›†æˆç³»ç»Ÿæµ‹è¯•
æµ‹è¯•å®Œæ•´çš„è¯­éŸ³å”¤é†’ + å‘½ä»¤å¤„ç†æµç¨‹
"""

import os
import sys
import tempfile
import logging
from pathlib import Path

sys.path.insert(0, '.')

def setup_test_environment():
    """è®¾ç½®æµ‹è¯•ç¯å¢ƒ"""
    # åˆ›å»ºæµ‹è¯•ç›®å½•
    test_dir = tempfile.mkdtemp(prefix="voice_test_")
    print(f"æµ‹è¯•ç›®å½•: {test_dir}")
    
    # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
    os.makedirs(os.path.join(test_dir, "notes"), exist_ok=True)
    os.makedirs(os.path.join(test_dir, "logs"), exist_ok=True)
    os.makedirs(os.path.join(test_dir, "tools"), exist_ok=True)
    
    # åˆ›å»ºæ¨¡æ‹Ÿçš„ daily_check è„šæœ¬
    daily_check_script = os.path.join(test_dir, "tools", "daily_check_asr_tts.py")
    with open(daily_check_script, "w", encoding="utf-8") as f:
        f.write("""#!/usr/bin/env python3
# æ¨¡æ‹Ÿçš„ daily_check è„šæœ¬
import sys
print("âœ… daily_check | ASR=OK TTS=OK NET=OK | search=test | top1=\"æµ‹è¯•ç»“æœ\"")
sys.exit(0)
""")
    
    return test_dir

def test_command_parsing():
    """æµ‹è¯•å‘½ä»¤è§£æ"""
    print("\nå‘½ä»¤è§£ææµ‹è¯•")
    print("=" * 60)
    
    from tools.voice_command_handler import VoiceCommandHandler
    
    handler = VoiceCommandHandler()
    
    test_cases = [
        ("å°ä¹æ£€æŸ¥ç³»ç»ŸçŠ¶æ€", "check_status", "æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"),
        ("æ·»åŠ ç¬”è®°æ˜å¤©å¼€ä¼š", "add_note", "æ·»åŠ ç¬”è®°"),
        ("æœç´¢äººå·¥æ™ºèƒ½", "search", "æœç´¢ä¿¡æ¯"),
        ("ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·", "weather", "æŸ¥è¯¢å¤©æ°”"),
        ("ç°åœ¨å‡ ç‚¹", "time", "æŸ¥è¯¢æ—¶é—´"),
        ("æµ‹è¯•è¯­éŸ³å‘½ä»¤", "test", "æµ‹è¯•å‘½ä»¤"),
        ("æœ‰ä»€ä¹ˆåŠŸèƒ½", "help", "æ˜¾ç¤ºå¸®åŠ©"),
    ]
    
    all_passed = True
    
    for cmd_text, expected_type, expected_desc in test_cases:
        cmd_type, cmd_info = handler.parse_command(cmd_text)
        
        if cmd_type == expected_type and cmd_info and cmd_info["description"] == expected_desc:
            print(f"[PASS] '{cmd_text}' -> {cmd_type} ({expected_desc})")
        else:
            print(f"[FAIL] '{cmd_text}'")
            print(f"  æœŸæœ›: {expected_type} ({expected_desc})")
            print(f"  å®é™…: {cmd_type} ({cmd_info['description'] if cmd_info else 'None'})")
            all_passed = False
    
    return all_passed

def test_command_execution():
    """æµ‹è¯•å‘½ä»¤æ‰§è¡Œ"""
    print("\nå‘½ä»¤æ‰§è¡Œæµ‹è¯•")
    print("=" * 60)
    
    test_dir = setup_test_environment()
    
    # ä¿®æ”¹å·¥ä½œç›®å½•
    original_dir = os.getcwd()
    os.chdir(test_dir)
    
    try:
        from tools.voice_command_handler import VoiceCommandHandler
        
        handler = VoiceCommandHandler()
        
        # æµ‹è¯•æ·»åŠ ç¬”è®°
        print("æµ‹è¯•æ·»åŠ ç¬”è®°å‘½ä»¤...")
        success, message = handler.execute_command("æ·»åŠ ç¬”è®°æµ‹è¯•å†…å®¹")
        
        if success:
            print(f"[PASS] æ·»åŠ ç¬”è®°æˆåŠŸ: {message}")
            
            # æ£€æŸ¥ç¬”è®°æ–‡ä»¶
            note_file = os.path.join("notes", "inbox.md")
            if os.path.exists(note_file):
                with open(note_file, "r", encoding="utf-8") as f:
                    content = f.read()
                if "æµ‹è¯•å†…å®¹" in content:
                    print("[PASS] ç¬”è®°å†…å®¹æ­£ç¡®")
                else:
                    print("[FAIL] ç¬”è®°å†…å®¹ä¸æ­£ç¡®")
            else:
                print("[FAIL] ç¬”è®°æ–‡ä»¶æœªåˆ›å»º")
        else:
            print(f"[FAIL] æ·»åŠ ç¬”è®°å¤±è´¥: {message}")
        
        # æµ‹è¯•çŠ¶æ€æ£€æŸ¥
        print("\næµ‹è¯•çŠ¶æ€æ£€æŸ¥å‘½ä»¤...")
        success, message = handler.execute_command("æ£€æŸ¥ç³»ç»ŸçŠ¶æ€")
        
        if success:
            print(f"[PASS] çŠ¶æ€æ£€æŸ¥æˆåŠŸ: {message}")
        else:
            print(f"[FAIL] çŠ¶æ€æ£€æŸ¥å¤±è´¥: {message}")
        
        # æµ‹è¯•å…¶ä»–å‘½ä»¤
        test_commands = [
            ("æœç´¢æµ‹è¯•", "search"),
            ("æŸ¥è¯¢å¤©æ°”", "weather"),
            ("ç°åœ¨æ—¶é—´", "time"),
            ("æµ‹è¯•å‘½ä»¤", "test"),
            ("æ˜¾ç¤ºå¸®åŠ©", "help"),
        ]
        
        for cmd_text, expected_type in test_commands:
            success, message = handler.execute_command(cmd_text)
            status = "PASS" if success else "FAIL"
            print(f"[{status}] {cmd_text}: {message}")
        
        return True
        
    finally:
        # æ¢å¤åŸå§‹ç›®å½•
        os.chdir(original_dir)
        
        # æ¸…ç†æµ‹è¯•ç›®å½•
        import shutil
        try:
            shutil.rmtree(test_dir)
            print(f"\nå·²æ¸…ç†æµ‹è¯•ç›®å½•: {test_dir}")
        except:
            pass

def test_full_integration():
    """æµ‹è¯•å®Œæ•´é›†æˆ"""
    print("\nå®Œæ•´é›†æˆæµ‹è¯•")
    print("=" * 60)
    
    # æ¨¡æ‹Ÿè¯­éŸ³å”¤é†’æµç¨‹
    from tools.wake_listener import is_meaningful_command
    
    wake_phrases = ["å°ä¹", "ä½ å¥½å°ä¹", "å°é…’"]
    
    test_scenarios = [
        {
            "name": "å®Œæ•´æœ‰æ•ˆå‘½ä»¤",
            "audio": "å°ä¹æ£€æŸ¥ç³»ç»ŸçŠ¶æ€",
            "should_process": True,
            "description": "å”¤é†’è¯ + æœ‰æ•ˆå‘½ä»¤"
        },
        {
            "name": "æ— æ„ä¹‰å‘½ä»¤",
            "audio": "ä½ å¥½å°ä¹",
            "should_process": False,
            "description": "å¯’æš„ + å”¤é†’è¯"
        },
        {
            "name": "çº¯æœ‰æ•ˆå‘½ä»¤",
            "audio": "æ£€æŸ¥ç³»ç»ŸçŠ¶æ€",
            "should_process": True,
            "description": "ç›´æ¥æœ‰æ•ˆå‘½ä»¤"
        },
        {
            "name": "æ·»åŠ ç¬”è®°å‘½ä»¤",
            "audio": "å°ä¹æ·»åŠ ç¬”è®°æµ‹è¯•å†…å®¹",
            "should_process": True,
            "description": "å”¤é†’è¯ + ç¬”è®°å‘½ä»¤"
        },
        {
            "name": "æœç´¢å‘½ä»¤",
            "audio": "æœç´¢äººå·¥æ™ºèƒ½",
            "should_process": True,
            "description": "æœç´¢å‘½ä»¤"
        },
    ]
    
    all_passed = True
    
    for scenario in test_scenarios:
        name = scenario["name"]
        audio = scenario["audio"]
        should_process = scenario["should_process"]
        description = scenario["description"]
        
        # æ£€æŸ¥å‘½ä»¤æ˜¯å¦æœ‰æ„ä¹‰
        is_meaningful = is_meaningful_command(audio, wake_phrases)
        
        # åˆ¤æ–­ç»“æœ
        passed = is_meaningful == should_process
        
        status = "[PASS]" if passed else "[FAIL]"
        print(f"{status} {name}")
        print(f"  éŸ³é¢‘: '{audio}'")
        print(f"  æè¿°: {description}")
        print(f"  æœŸæœ›å¤„ç†: {should_process}, å®é™…æœ‰æ„ä¹‰: {is_meaningful}")
        
        if not passed:
            all_passed = False
        
        print()
    
    return all_passed

def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("è¯­éŸ³å”¤é†’ç³»ç»Ÿå®Œæ•´é›†æˆæµ‹è¯•")
    print("=" * 60)
    
    results = []
    
    results.append(("å‘½ä»¤è§£æ", test_command_parsing()))
    results.append(("å‘½ä»¤æ‰§è¡Œ", test_command_execution()))
    results.append(("å®Œæ•´é›†æˆ", test_full_integration()))
    
    print("\n" + "=" * 60)
    print("æµ‹è¯•ç»“æœæ±‡æ€»:")
    print("=" * 60)
    
    all_passed = True
    for test_name, result in results:
        status = "PASS" if result else "FAIL"
        print(f"{test_name}: [{status}]")
        if not result:
            all_passed = False
    
    print("\n" + "=" * 60)
    if all_passed:
        print("[SUCCESS] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ï¼")
        print()
        print("ç³»ç»ŸåŠŸèƒ½æ€»ç»“:")
        print("1. [OK] è¯­éŸ³å”¤é†’æ£€æµ‹")
        print("2. [OK] å‘½ä»¤è¿‡æ»¤å™¨")
        print("3. [OK] å‘½ä»¤è§£æå™¨")
        print("4. [OK] å‘½ä»¤æ‰§è¡Œå™¨")
        print("5. [OK] ç¬”è®°ç®¡ç†")
        print("6. [OK] çŠ¶æ€æ£€æŸ¥")
        print("7. [OK] å®Œæ•´é›†æˆ")
        print()
        print("ğŸ‰ è¯­éŸ³å”¤é†’ç³»ç»Ÿå·²å®Œå…¨é›†æˆï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼")
        return 0
    else:
        print("[WARNING] éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´ã€‚")
        return 1

if __name__ == "__main__":
    sys.exit(main())