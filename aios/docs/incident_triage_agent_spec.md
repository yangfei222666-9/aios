# Incident Triage Agent - Agent Spec

**创建日期：** 2026-02-24  
**目的：** 事故分诊/止血，快速判断影响、自动降级、生成工单

---

## 输入事件

### 触发条件（任一满足即触发）
1. **超时飙升** - 1小时内超时 ≥10 次
2. **失败率上升** - 失败率 ≥30%
3. **502 连续** - 502 错误 ≥5 次
4. **熔断器打开** - 熔断器打开 ≥3 次

### 输入数据源
- `events.jsonl` - 错误事件
- `agent_traces.jsonl` - Agent 执行记录
- `alert_fsm.jsonl` - 告警状态

---

## 输出事件

### 工单格式
```json
{
  "id": "INC-20260224191805",
  "timestamp": "2026-02-24T19:18:05",
  "title": "超时飙升：1小时内 15 次超时",
  "severity": "high",
  "signal": {...},
  "root_causes": [
    {
      "signature": "Timeout after Ns",
      "count": 15,
      "affected_agents": ["agent_coder_001"],
      "recommendation": "增加超时时间或优化慢操作"
    }
  ],
  "mitigation_actions": [
    {
      "type": "increase_timeout",
      "description": "临时增加超时时间 +50%",
      "applied": true
    }
  ],
  "status": "open"
}
```

### 输出文件
- `incidents/INC-*.json` - 工单详情
- `incidents/triage_*.json` - 分诊报告

---

## 工作流程

### Phase 1: 检测异常信号
```
遍历最近1小时数据 → 统计异常指标 → 判断是否超过阈值
```

**检测项：**
- 超时次数
- 失败率
- 502 错误
- 熔断器状态

### Phase 2: 聚类错误（找 root cause）
```
收集错误 → 生成签名 → 聚类 → 找出 top3
```

**分析维度：**
- 错误签名（去除变化部分）
- 受影响的 Agent
- 常用工具
- 共同特征

### Phase 3: 自动止血
```
根据信号类型 → 选择止血策略 → 执行低风险动作 → 记录
```

**止血策略：**
| 信号类型 | 止血动作 | 风险 | 自动执行 |
|---------|---------|------|---------|
| 超时飙升 | 增加超时 +50% | 低 | ✅ |
| 失败率上升 | 降低并发 -50% | 低 | ✅ |
| 502 连续 | 切换 Provider | 中 | ❌ 需确认 |
| 熔断器打开 | 已熔断，等待恢复 | 无 | ✅ |

### Phase 4: 生成工单
```
汇总证据 → 生成建议 → 保存工单 → 发送通知
```

**工单内容：**
- 标题和严重程度
- 异常信号
- Root causes（top3）
- 已执行的止血动作
- 修复建议

---

## 成功标准

### 检测准确性
- ✅ 真实异常必须触发（召回率 >95%）
- ✅ 误报率 <10%

### 止血有效性
- ✅ 低风险动作自动执行
- ✅ 中高风险动作需要确认
- ✅ 止血后异常指标下降

### 工单质量
- ✅ Root cause 准确（top3 覆盖 >80% 错误）
- ✅ 建议可执行
- ✅ 证据完整

---

## 失败回滚

### 止血失败
```
止血动作执行失败 → 记录到工单 → 通知人工介入
```

### 误判
```
检测到误报 → 调整阈值 → 更新检测逻辑
```

### 恢复
```
异常消失 → 自动关闭工单 → 恢复原配置
```

---

## 集成到 Scheduler

### 触发方式
```python
# 方式 1: 定时检查（每 10 分钟）
schedule = {"kind": "cron", "expr": "*/10 * * * *"}

# 方式 2: 事件触发（推荐）
trigger_events = [
    "error_spike",
    "timeout_spike",
    "failure_rate_high",
    "circuit_breaker_open"
]
```

### 优先级
- **Critical 信号** - 立即执行（P0）
- **High 信号** - 5 分钟内执行（P1）
- **Medium 信号** - 10 分钟内执行（P2）

---

## 集成到 Reactor

### Playbook 示例
```json
{
  "id": "pb-incident-timeout-spike",
  "trigger": {
    "event_type": "timeout_spike",
    "threshold": 10
  },
  "actions": [
    {
      "type": "run_agent",
      "agent": "incident_triage_agent",
      "timeout": 300
    }
  ],
  "cooldown": 600
}
```

---

## 监控指标

### 运行指标
- 检测次数
- 触发次数
- 误报次数
- 平均响应时间

### 止血效果
- 止血成功率
- 异常恢复时间
- 人工介入次数

### 工单质量
- 工单数量
- 关闭率
- 平均处理时间

---

## 首次运行结果

**时间：** 2026-02-24 19:18:05  
**状态：** ✅ 无异常，系统正常  
**输出：** INCIDENT_OK

---

## 下一步

### 短期（1-2 天）
1. 集成到 Scheduler（事件触发）
2. 添加 Playbook（自动响应）
3. 测试止血效果

### 中期（1-2 周）
1. 优化检测阈值（减少误报）
2. 增加止血策略（更多场景）
3. 完善工单模板

### 长期（1-2 月）
1. 机器学习预测（提前预警）
2. 自动关闭工单（异常恢复后）
3. 历史分析（识别重复事故）

---

## 总结

✅ **Incident Triage Agent 已就绪**  
✅ **4 阶段分诊流程**  
✅ **自动止血 + 生成工单**  
✅ **集成 Scheduler + Reactor**

**核心价值：**
- 快速判断影响（1 分钟内）
- 自动止血（低风险动作）
- 解放人工（不用看日志）
- 完整证据（工单 + 建议）

---

*"Detect, triage, mitigate, document."*
