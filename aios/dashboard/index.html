<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOS æ§åˆ¶å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e6ed;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1729 100%);
            padding: 20px 40px;
            border-bottom: 1px solid #1e2847;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 600;
        }

        .logo-icon {
            font-size: 32px;
        }

        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 14px;
            color: #8b92a7;
        }

        .container {
            padding: 30px 40px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .top-cards {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .top-cards > .evolution-card {
            grid-column: span 2;
        }

        .big-card {
            background: linear-gradient(135deg, #1e2847 0%, #151b33 100%);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            border: 1px solid #2a3555;
            position: relative;
            cursor: help;
        }

        .big-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .card-tooltip {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
        }

        .big-card:hover .card-tooltip {
            opacity: 1;
        }

        .big-number {
            font-size: 64px;
            font-weight: 700;
            margin: 10px 0;
        }

        .big-label {
            font-size: 14px;
            color: #8b92a7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-healthy { background: #10b981; color: #fff; }
        .status-degraded { background: #f59e0b; color: #fff; }
        .status-critical { background: #ef4444; color: #fff; }
        .status-warning { background: #f59e0b; color: #fff; }
        .status-idle { background: #6b7280; color: #fff; }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #1e2847 0%, #151b33 100%);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #2a3555;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 600;
        }

        .card-icon {
            font-size: 20px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .evolution-card {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            text-align: center;
            padding: 40px;
        }

        .evolution-score {
            font-size: 96px;
            font-weight: 700;
            margin: 20px 0;
        }

        .evolution-grade {
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .evolution-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .evolution-item {
            text-align: left;
        }

        .evolution-item-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .evolution-item-value {
            font-size: 28px;
            font-weight: 700;
        }

        .reactor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .reactor-stat {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .reactor-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .reactor-value {
            font-size: 48px;
            font-weight: 700;
            margin: 10px 0;
        }

        .reactor-label {
            font-size: 12px;
            color: #8b92a7;
            line-height: 1.4;
        }

        .pipeline-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pipeline-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .pipeline-time {
            color: #8b92a7;
            font-size: 14px;
        }

        .pipeline-duration {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .duration-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f59e0b;
        }

        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-message {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .alert-time {
            font-size: 12px;
            color: #8b92a7;
        }

        .event-stream {
            background: #0f1729;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .event-line {
            padding: 4px 0;
            border-bottom: 1px solid #1e2847;
        }

        .event-time {
            color: #6b7280;
            margin-right: 10px;
        }

        .event-layer {
            color: #3b82f6;
            margin-right: 10px;
        }

        .event-type {
            color: #10b981;
        }

        .no-data {
            text-align: center;
            color: #6b7280;
            padding: 40px;
            font-size: 14px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e2847;
        }

        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <span class="logo-icon">ğŸ¤–</span>
            <span>AIOS æ§åˆ¶å°</span>
        </div>
        <div class="header-right">
            <span>æœ€åæ›´æ–°: <span id="last-update">--:--</span></span>
            <span id="connection-status">ğŸ”´ ç¦»çº¿</span>
        </div>
    </div>

    <div class="container">
        <!-- Top Big Cards -->
        <div class="top-cards">
            <div class="big-card evolution-card" style="grid-column: span 2;">
                <div class="evolution-grade" id="evolution-grade">å¥åº·</div>
                <div class="evolution-score" id="evolution-score">0.00</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 10px;">ç³»ç»Ÿè¿›åŒ–åˆ†æ•°ï¼ˆç»¼åˆè¯„ä¼°ç³»ç»Ÿè‡ªæˆ‘æ”¹è¿›èƒ½åŠ›ï¼‰</div>
                <div class="evolution-breakdown" style="margin-top: 20px;">
                    <div class="evolution-item">
                        <div class="evolution-item-label">åŸºçº¿åˆ†ï¼ˆå·¥å…·æˆåŠŸç‡ï¼‰</div>
                        <div class="evolution-item-value" id="evolution-base">0.00</div>
                    </div>
                    <div class="evolution-item">
                        <div class="evolution-item-label">Reactoråˆ†ï¼ˆè‡ªåŠ¨ä¿®å¤èƒ½åŠ›ï¼‰</div>
                        <div class="evolution-item-value" id="evolution-reactor">0.00</div>
                    </div>
                    <div class="evolution-item">
                        <div class="evolution-item-label">è‡ªåŠ¨ä¿®å¤ç‡</div>
                        <div class="evolution-item-value" id="evolution-auto">0%</div>
                    </div>
                    <div class="evolution-item">
                        <div class="evolution-item-label">éªŒè¯é€šè¿‡ç‡</div>
                        <div class="evolution-item-value" id="evolution-verify">0%</div>
                    </div>
                </div>
            </div>
            <div class="big-card">
                <div class="big-label">ç³»ç»ŸçŠ¶æ€</div>
                <div class="big-number" id="system-status">--</div>
                <div class="status-badge status-healthy" id="status-badge">å¥åº·</div>
                <div class="card-tooltip">ç³»ç»Ÿæ•´ä½“å¥åº·åº¦ï¼šåŸºäºé”™è¯¯ç‡å’Œäº‹ä»¶é‡è¯„ä¼°</div>
            </div>
            <div class="big-card">
                <div class="big-label">äº‹ä»¶ (1å°æ—¶)</div>
                <div class="big-number" id="events-1h">0</div>
                <div class="card-tooltip">æœ€è¿‘1å°æ—¶å†…ç³»ç»Ÿäº§ç”Ÿçš„æ‰€æœ‰äº‹ä»¶æ•°é‡</div>
            </div>
            <div class="big-card">
                <div class="big-label">æ´»è·ƒ Agent</div>
                <div class="big-number" id="active-agents">0</div>
                <div class="card-tooltip">å½“å‰æ­£åœ¨è¿è¡Œçš„ Agent æ•°é‡ï¼ˆ1å°æ—¶å†…æ´»è·ƒï¼‰</div>
            </div>
            <div class="big-card">
                <div class="big-label">å¾…å¤„ç†å‘Šè­¦</div>
                <div class="big-number" id="open-alerts">0</div>
                <div class="card-tooltip">éœ€è¦äººå·¥ç¡®è®¤æˆ–å¤„ç†çš„å‘Šè­¦æ•°é‡</div>
            </div>
        </div>

        <!-- System Resources Row -->
        <div class="grid-3">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ’»</span>
                    <span>CPU ä½¿ç”¨ç‡</span>
                </div>
                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 48px; font-weight: 700; color: #3b82f6;" id="cpu-usage">0%</div>
                    <div style="font-size: 14px; color: #8b92a7; margin-top: 10px;">å¹³å‡è´Ÿè½½: <span id="cpu-load">0.0</span></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ®</span>
                    <span>GPU ä½¿ç”¨ç‡</span>
                </div>
                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 48px; font-weight: 700; color: #10b981;" id="gpu-usage">0%</div>
                    <div style="font-size: 14px; color: #8b92a7; margin-top: 10px;">æ¸©åº¦: <span id="gpu-temp">--</span>Â°C</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ’¾</span>
                    <span>å†…å­˜ä½¿ç”¨ç‡</span>
                </div>
                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 48px; font-weight: 700; color: #f59e0b;" id="memory-usage">0%</div>
                    <div style="font-size: 14px; color: #8b92a7; margin-top: 10px;"><span id="memory-used">0</span> / <span id="memory-total">0</span> GB</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span>æ¯æ—¥äº‹ä»¶é‡ï¼ˆæœ€è¿‘7å¤©ï¼‰</span>
                </div>
                <div class="chart-container">
                    <canvas id="events-chart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“ˆ</span>
                    <span>è¿›åŒ–è¶‹åŠ¿ï¼ˆåŸºçº¿åˆ† vs Reactoråˆ†ï¼‰</span>
                </div>
                <div class="chart-container">
                    <canvas id="evolution-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Middle Row -->
        <div class="grid-3">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">âš¡</span>
                    <span>REACTOR è‡ªåŠ¨å“åº”</span>
                </div>
                <div class="reactor-grid">
                    <div class="reactor-stat">
                        <div class="reactor-icon">ğŸ¯</div>
                        <div class="reactor-value" id="reactor-exec">0%</div>
                        <div class="reactor-label">è‡ªåŠ¨æ‰§è¡Œç‡ï¼ˆåŒ¹é…åè‡ªåŠ¨æ‰§è¡Œçš„æ¯”ä¾‹ï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">âœ…</div>
                        <div class="reactor-value" id="reactor-verify">0%</div>
                        <div class="reactor-label">éªŒè¯é€šè¿‡ç‡ï¼ˆæ‰§è¡ŒåéªŒè¯æˆåŠŸçš„æ¯”ä¾‹ï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">ğŸ“¦</div>
                        <div class="reactor-value" id="reactor-playbooks">0</div>
                        <div class="reactor-label">æ€»å‰§æœ¬æ•°ï¼ˆå¯ç”¨çš„è‡ªåŠ¨ä¿®å¤è§„åˆ™ï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">ğŸ”’</div>
                        <div class="reactor-value" id="reactor-breakers">0</div>
                        <div class="reactor-label">ç†”æ–­å™¨ï¼ˆå½“å‰è§¦å‘ç†”æ–­çš„æ•°é‡ï¼‰</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ”„</span>
                    <span>PIPELINE è¿è¡Œå†å²ï¼ˆæœ€è¿‘10æ¬¡ï¼‰</span>
                </div>
                <div class="pipeline-list" id="pipeline-list">
                    <div class="no-data">æš‚æ— æ•°æ®</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ¤–</span>
                    <span>Agent çŠ¶æ€</span>
                </div>
                <div id="agent-summary" style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: #8b92a7; margin-bottom: 10px;">æ€»æ•°</div>
                            <div style="font-size: 48px; font-weight: 700; color: #3b82f6;" id="agent-total">0</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: #8b92a7; margin-bottom: 10px;">å·²å½’æ¡£</div>
                            <div style="font-size: 48px; font-weight: 700; color: #6b7280;" id="agent-archived">0</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #2a3555;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span style="color: #8b92a7;">å®Œæˆä»»åŠ¡:</span>
                            <span style="color: #e0e6ed;" id="agent-tasks">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Row -->
        <div class="grid-3">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">âš ï¸</span>
                    <span>å‘Šè­¦è¯¦æƒ…ï¼ˆæœ€è¿‘5æ¡ï¼‰</span>
                </div>
                <div class="alert-list" id="alert-list">
                    <div class="no-data">æš‚æ— å‘Šè­¦</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ”´</span>
                    <span>äº‹ä»¶æµï¼ˆå®æ—¶æ»šåŠ¨ï¼Œæœ€è¿‘20æ¡ï¼‰</span>
                </div>
                <div class="event-stream" id="event-stream">
                    <div class="no-data">ç­‰å¾…äº‹ä»¶...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ› ï¸</span>
                    <span>å·¥å…·ä½¿ç”¨ç»Ÿè®¡ï¼ˆ1å°æ—¶ï¼‰</span>
                </div>
                <div id="tool-stats" style="padding: 15px;">
                    <div class="no-data">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- Additional Row -->
        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span>ç£ç›˜ä½¿ç”¨æƒ…å†µ</span>
                </div>
                <div id="disk-usage" style="padding: 20px;">
                    <div class="no-data">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸŒ</span>
                    <span>ç½‘ç»œçŠ¶æ€</span>
                </div>
                <div id="network-status" style="padding: 20px;">
                    <div class="no-data">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart.js é…ç½®
        Chart.defaults.color = '#8b92a7';
        Chart.defaults.borderColor = '#2a3555';

        let eventsChart, evolutionChart;
        let ws = null;
        let reconnectTimer = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æ¯æ—¥äº‹ä»¶é‡æŸ±çŠ¶å›¾
            const eventsCtx = document.getElementById('events-chart').getContext('2d');
            eventsChart = new Chart(eventsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'äº‹ä»¶æ•°',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#2a3555' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // è¿›åŒ–è¶‹åŠ¿æŠ˜çº¿å›¾
            const evolutionCtx = document.getElementById('evolution-chart').getContext('2d');
            evolutionChart = new Chart(evolutionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'åŸºçº¿åˆ†',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Reactoråˆ†',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            grid: { color: '#2a3555' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // æ›´æ–° Dashboard
        function updateDashboard(data) {
            // æ›´æ–°æ—¶é—´
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('zh-CN');

            // ç³»ç»Ÿå¥åº·
            const health = data.system_health || {};
            const eventsCount = health.events_1h || 0;
            const errorsCount = health.errors_1h || 0;
            const warningsCount = health.warnings_1h || 0;
            
            document.getElementById('events-1h').textContent = eventsCount;
            
            // ç³»ç»ŸçŠ¶æ€åˆ¤å®šè§„åˆ™
            const statusElement = document.getElementById('system-status');
            const statusBadge = document.getElementById('status-badge');
            
            let status = 'healthy';
            let statusText = 'å¥åº·';
            let statusDisplay = 'æ­£å¸¸';
            
            // åˆ¤å®šé€»è¾‘
            if (errorsCount > 10) {
                status = 'critical';
                statusText = 'ä¸¥é‡';
                statusDisplay = 'æ•…éšœ';
            } else if (errorsCount > 0 || warningsCount > 5) {
                status = 'warning';
                statusText = 'è­¦å‘Š';
                statusDisplay = 'å¼‚å¸¸';
            } else if (eventsCount === 0) {
                status = 'idle';
                statusText = 'ç©ºé—²';
                statusDisplay = 'ç©ºé—²';
            } else {
                status = 'healthy';
                statusText = 'å¥åº·';
                statusDisplay = 'æ­£å¸¸';
            }
            
            if (statusElement) {
                statusElement.textContent = statusDisplay;
            }
            
            if (statusBadge) {
                statusBadge.textContent = statusText;
                statusBadge.className = 'status-badge status-' + status;
            }

            // Agent çŠ¶æ€
            const agents = data.agents || {};
            document.getElementById('active-agents').textContent = agents.active || 0;
            
            // Agent è¯¦ç»†ç»Ÿè®¡
            const agentTotalElement = document.getElementById('agent-total');
            const agentArchivedElement = document.getElementById('agent-archived');
            const agentTasksElement = document.getElementById('agent-tasks');
            
            if (agentTotalElement) agentTotalElement.textContent = agents.total || 0;
            if (agentArchivedElement) agentArchivedElement.textContent = agents.archived || 0;
            if (agentTasksElement) agentTasksElement.textContent = agents.total_tasks || 0;

            // å‘Šè­¦
            const alerts = data.alerts || {};
            document.getElementById('open-alerts').textContent = alerts.open || 0;

            // æ¯æ—¥äº‹ä»¶é‡å›¾è¡¨
            if (data.daily_events && data.daily_events.length > 0) {
                const labels = data.daily_events.map(d => d.date);
                const counts = data.daily_events.map(d => d.count);
                
                console.log('Daily events:', labels, counts); // Debug
                
                eventsChart.data.labels = labels;
                eventsChart.data.datasets[0].data = counts;
                eventsChart.update('none'); // æ— åŠ¨ç”»æ›´æ–°ï¼Œæ›´æµç•…
            }

            // è¿›åŒ–è¶‹åŠ¿å›¾è¡¨
            if (data.evolution_trend && data.evolution_trend.length > 0) {
                const labels = data.evolution_trend.map(d => d.time);
                const baseData = data.evolution_trend.map(d => d.base);
                const reactorData = data.evolution_trend.map(d => d.reactor);
                
                console.log('Evolution trend:', labels, baseData, reactorData); // Debug
                
                evolutionChart.data.labels = labels;
                evolutionChart.data.datasets[0].data = baseData;
                evolutionChart.data.datasets[1].data = reactorData;
                evolutionChart.update('none');
            }

            // Reactor ç»Ÿè®¡
            const reactor = data.reactor_stats || {};
            console.log('Reactor data:', reactor);
            console.log('auto_exec_rate:', reactor.auto_exec_rate);
            console.log('verify_rate:', reactor.verify_rate);
            console.log('total_playbooks:', reactor.total_playbooks);
            
            document.getElementById('reactor-exec').textContent = Math.round((reactor.auto_exec_rate || 0) * 100) + '%';
            document.getElementById('reactor-verify').textContent = Math.round((reactor.verify_rate || 0) * 100) + '%';
            document.getElementById('reactor-playbooks').textContent = reactor.total_playbooks || 0;
            document.getElementById('reactor-breakers').textContent = reactor.breakers_active || 0;

            // Evolution å¡ç‰‡
            const evolution = data.evolution || {};
            const evolutionScore = evolution.score || 0;
            const evolutionScoreElement = document.getElementById('evolution-score');
            if (evolutionScoreElement) {
                evolutionScoreElement.textContent = evolutionScore.toFixed(2);
            }
            
            const grade = evolution.grade || 'unknown';
            const gradeText = grade === 'healthy' ? 'å¥åº·' : grade === 'degraded' ? 'é™çº§' : grade === 'critical' ? 'ä¸¥é‡' : 'æœªçŸ¥';
            const gradeElement = document.getElementById('evolution-grade');
            if (gradeElement) {
                gradeElement.textContent = gradeText;
            }
            
            const baseElement = document.getElementById('evolution-base');
            const reactorElement = document.getElementById('evolution-reactor');
            const autoElement = document.getElementById('evolution-auto');
            const verifyElement = document.getElementById('evolution-verify');
            
            if (baseElement) baseElement.textContent = (evolution.base || 0).toFixed(2);
            if (reactorElement) reactorElement.textContent = (evolution.reactor || 0).toFixed(2);
            if (autoElement) autoElement.textContent = Math.round((reactor.auto_exec_rate || 0) * 100) + '%';
            if (verifyElement) verifyElement.textContent = Math.round((reactor.verify_rate || 0) * 100) + '%';

            // Evolution å¡ç‰‡é¢œè‰²
            const evolutionCard = document.querySelector('.evolution-card');
            if (grade === 'healthy') {
                evolutionCard.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else if (grade === 'degraded') {
                evolutionCard.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else if (grade === 'critical') {
                evolutionCard.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }

            // Pipeline è¿è¡Œå†å²
            const pipelineList = document.getElementById('pipeline-list');
            if (pipelineList && data.pipeline_runs && data.pipeline_runs.length > 0) {
                console.log('Pipeline runs:', data.pipeline_runs); // Debug
                pipelineList.innerHTML = data.pipeline_runs.slice(0, 4).map(run => `
                    <div class="pipeline-item">
                        <span class="pipeline-time">${run.time}</span>
                        <span class="pipeline-duration">
                            <span class="duration-dot"></span>
                            ${run.duration_ms}ms
                        </span>
                    </div>
                `).join('');
            } else if (pipelineList) {
                pipelineList.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
            }

            // å‘Šè­¦åˆ—è¡¨
            const alertList = document.getElementById('alert-list');
            if (alerts.recent && alerts.recent.length > 0) {
                alertList.innerHTML = alerts.recent.slice(0, 5).map(alert => {
                    const stateText = alert.state === 'OPEN' ? 'å¾…å¤„ç†' : alert.state === 'ACK' ? 'å·²ç¡®è®¤' : 'å·²è§£å†³';
                    return `
                        <div class="alert-item">
                            <span class="alert-icon">âš ï¸</span>
                            <div class="alert-content">
                                <div class="alert-message">${alert.message || 'æœªçŸ¥å‘Šè­¦'}</div>
                                <div class="alert-time">${stateText} | ${alert.created_at || ''}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                alertList.innerHTML = '<div class="no-data">æš‚æ— å‘Šè­¦</div>';
            }

            // äº‹ä»¶æµ
            const eventStream = document.getElementById('event-stream');
            if (data.event_stream && data.event_stream.length > 0) {
                eventStream.innerHTML = data.event_stream.slice(-20).reverse().map(event => {
                    const timeStr = event.ts ? event.ts.split('T')[1].substring(0, 8) : '';
                    return `
                        <div class="event-line">
                            <span class="event-time">${timeStr}</span>
                            <span class="event-layer">[${event.layer || 'UNKNOWN'}]</span>
                            <span class="event-type">${event.event || 'unknown'}</span>
                        </div>
                    `;
                }).join('');
            }

            // ç³»ç»Ÿèµ„æºç›‘æ§
            if (data.system_resources) {
                const res = data.system_resources;
                
                // CPU
                const cpuElement = document.getElementById('cpu-usage');
                const cpuLoadElement = document.getElementById('cpu-load');
                if (cpuElement && res.cpu) {
                    cpuElement.textContent = Math.round(res.cpu.usage || 0) + '%';
                    cpuElement.style.color = res.cpu.usage > 80 ? '#ef4444' : res.cpu.usage > 60 ? '#f59e0b' : '#3b82f6';
                }
                if (cpuLoadElement && res.cpu) {
                    cpuLoadElement.textContent = (res.cpu.load || 0).toFixed(2);
                }
                
                // GPU
                const gpuElement = document.getElementById('gpu-usage');
                const gpuTempElement = document.getElementById('gpu-temp');
                if (gpuElement && res.gpu) {
                    gpuElement.textContent = Math.round(res.gpu.usage || 0) + '%';
                    gpuElement.style.color = res.gpu.usage > 80 ? '#ef4444' : res.gpu.usage > 60 ? '#f59e0b' : '#10b981';
                }
                if (gpuTempElement && res.gpu) {
                    gpuTempElement.textContent = res.gpu.temperature || '--';
                }
                
                // Memory
                const memoryElement = document.getElementById('memory-usage');
                const memoryUsedElement = document.getElementById('memory-used');
                const memoryTotalElement = document.getElementById('memory-total');
                if (memoryElement && res.memory) {
                    memoryElement.textContent = Math.round(res.memory.percent || 0) + '%';
                    memoryElement.style.color = res.memory.percent > 80 ? '#ef4444' : res.memory.percent > 60 ? '#f59e0b' : '#f59e0b';
                }
                if (memoryUsedElement && res.memory) {
                    memoryUsedElement.textContent = (res.memory.used_gb || 0).toFixed(1);
                }
                if (memoryTotalElement && res.memory) {
                    memoryTotalElement.textContent = (res.memory.total_gb || 0).toFixed(1);
                }
            }

            // å·¥å…·ä½¿ç”¨ç»Ÿè®¡
            if (data.tool_stats) {
                const toolStatsDiv = document.getElementById('tool-stats');
                if (toolStatsDiv) {
                    const stats = data.tool_stats;
                    const tools = Object.keys(stats).filter(k => stats[k].total > 0);
                    
                    if (tools.length > 0) {
                        toolStatsDiv.innerHTML = tools.map(tool => {
                            const s = stats[tool];
                            const successRate = s.total > 0 ? Math.round((s.success / s.total) * 100) : 0;
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #2a3555;">
                                    <span style="font-weight: 600;">${tool}</span>
                                    <div style="display: flex; gap: 15px; font-size: 14px;">
                                        <span style="color: #10b981;">âœ“ ${s.success}</span>
                                        <span style="color: #ef4444;">âœ— ${s.failed}</span>
                                        <span style="color: #8b92a7;">${s.avg_ms}ms</span>
                                        <span style="color: ${successRate >= 90 ? '#10b981' : successRate >= 70 ? '#f59e0b' : '#ef4444'};">${successRate}%</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        toolStatsDiv.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
                    }
                }
            }

            // ç£ç›˜ä½¿ç”¨æƒ…å†µ
            if (data.disk_usage) {
                const diskDiv = document.getElementById('disk-usage');
                if (diskDiv) {
                    const disks = data.disk_usage;
                    diskDiv.innerHTML = disks.map(disk => {
                        const percent = disk.percent || 0;
                        const color = percent > 90 ? '#ef4444' : percent > 70 ? '#f59e0b' : '#10b981';
                        return `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: 600;">${disk.mount}</span>
                                    <span style="color: ${color};">${percent.toFixed(1)}%</span>
                                </div>
                                <div style="background: #1e2847; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: ${color}; height: 100%; width: ${percent}%; transition: width 0.3s ease;"></div>
                                </div>
                                <div style="font-size: 12px; color: #8b92a7; margin-top: 5px;">
                                    ${disk.used_gb.toFixed(1)} GB / ${disk.total_gb.toFixed(1)} GB
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // ç½‘ç»œçŠ¶æ€
            if (data.network_status) {
                const netDiv = document.getElementById('network-status');
                if (netDiv) {
                    const net = data.network_status;
                    netDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #8b92a7; margin-bottom: 10px;">ä¸‹è½½é€Ÿåº¦</div>
                                <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${net.download_mbps.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #8b92a7; margin-top: 5px;">MB/s</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #8b92a7; margin-bottom: 10px;">ä¸Šä¼ é€Ÿåº¦</div>
                                <div style="font-size: 32px; font-weight: 700; color: #10b981;">${net.upload_mbps.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #8b92a7; margin-top: 5px;">MB/s</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #2a3555;">
                            <div style="display: flex; justify-content: space-between; font-size: 14px;">
                                <span style="color: #8b92a7;">æ€»ä¸‹è½½:</span>
                                <span style="color: #e0e6ed;">${net.total_download_gb.toFixed(2)} GB</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 8px;">
                                <span style="color: #8b92a7;">æ€»ä¸Šä¼ :</span>
                                <span style="color: #e0e6ed;">${net.total_upload_gb.toFixed(2)} GB</span>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // WebSocket è¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('connection-status').textContent = 'ğŸŸ¢ åœ¨çº¿';
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('connection-status').textContent = 'ğŸ”´ ç¦»çº¿';
                // 5ç§’åé‡è¿
                reconnectTimer = setTimeout(connectWebSocket, 5000);
            };
        }

        // HTTP è½®è¯¢é™çº§
        async function pollSnapshot() {
            try {
                const response = await fetch('/api/snapshot');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('Dashboard initializing...'); // Debug
            initCharts();
            connectWebSocket();
            
            // ç«‹å³æ‹‰å–ä¸€æ¬¡æ•°æ®
            pollSnapshot();
            
            // å¦‚æœ WebSocket å¤±è´¥ï¼Œé™çº§åˆ° HTTP è½®è¯¢
            setTimeout(() => {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    console.log('WebSocket failed, falling back to HTTP polling');
                    setInterval(pollSnapshot, 10000); // 10ç§’è½®è¯¢
                }
            }, 3000);
        });
    </script>
</body>
</html>
