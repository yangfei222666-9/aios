<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="only light">
<title>AIOS Dashboard - å°ä¹æ§åˆ¶å°</title>
<style>
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
@keyframes barGrow{from{width:0}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes breathe{0%,100%{box-shadow:0 0 15px rgba(34,197,94,.2)}50%{box-shadow:0 0 30px rgba(34,197,94,.5)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

*{margin:0;padding:0;box-sizing:border-box}
body{background:#0f0f1a;color:#eee;font-family:'Segoe UI',system-ui,sans-serif;padding:20px;min-height:100vh}

/* Header */
.header{display:flex;align-items:center;gap:14px;margin-bottom:24px;animation:fadeUp .5s ease}
.header .logo{font-size:2.2em}
.header h1{font-size:1.8em;color:#fff;font-weight:900;letter-spacing:-0.5px}
.header-right{margin-left:auto;text-align:right}
.header-right .time{color:#c4b5fd;font-size:.9em;font-weight:600}
.header-right .refresh-info{color:#666;font-size:.72em;margin-top:2px;display:flex;align-items:center;gap:4px;justify-content:flex-end}
.refresh-dot{width:6px;height:6px;border-radius:50%;background:#22c55e;animation:blink 2s infinite}
.refresh-spinner{width:12px;height:12px;border:2px solid #333;border-top-color:#c4b5fd;border-radius:50%;animation:spin .8s linear infinite;display:none}

.grid{display:grid;gap:14px;margin-bottom:14px}
.g4{grid-template-columns:repeat(4,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g2{grid-template-columns:repeat(2,1fr)}

.card{background:#161625;border:1px solid #1e1e35;border-radius:14px;padding:20px;animation:fadeUp .5s ease backwards;transition:border-color .3s,box-shadow .3s}
.card:hover{border-color:#2a2a4a;box-shadow:0 4px 20px rgba(0,0,0,.3)}
.card:nth-child(1){animation-delay:.05s}.card:nth-child(2){animation-delay:.1s}.card:nth-child(3){animation-delay:.15s}.card:nth-child(4){animation-delay:.2s}
.card h2{font-size:.72em;color:#888;text-transform:uppercase;letter-spacing:2.5px;margin-bottom:14px;font-weight:700;display:flex;align-items:center;gap:6px}
.card h2 .icon{font-size:1.2em}

/* Num blocks with glow */
.num-block{border-radius:14px;padding:22px 10px;text-align:center;margin:8px 0;transition:all .5s ease}
.num-block .n{font-size:3.8em;font-weight:900;color:#000;line-height:1;transition:all .5s ease}
.num-block .l{font-size:.82em;color:#333;margin-top:6px;font-weight:700;letter-spacing:1px}
.num-block.green{background:linear-gradient(135deg,#22c55e,#16a34a);animation:breathe 3s infinite}
.num-block.yellow{background:linear-gradient(135deg,#eab308,#ca8a04)}
.num-block.red{background:linear-gradient(135deg,#ef4444,#dc2626)}.num-block.red .n,.num-block.red .l{color:#fff}
.num-block.purple{background:linear-gradient(135deg,#8b5cf6,#7c3aed)}.num-block.purple .n,.num-block.purple .l{color:#fff}

.sub{font-size:.78em;color:#666;margin-top:8px;text-align:center}

/* Progress */
.prog{width:100%;height:8px;background:#1e1e35;border-radius:4px;margin-top:12px;overflow:hidden}
.prog-fill{height:100%;border-radius:4px;transition:width 1s ease}

/* Bars */
.bars{display:flex;flex-direction:column;gap:10px}
.br{display:flex;align-items:center;gap:10px;animation:slideIn .4s ease backwards}
.br:nth-child(1){animation-delay:.1s}.br:nth-child(2){animation-delay:.15s}.br:nth-child(3){animation-delay:.2s}.br:nth-child(4){animation-delay:.25s}.br:nth-child(5){animation-delay:.3s}.br:nth-child(6){animation-delay:.35s}
.br .name{width:80px;text-align:right;font-size:.85em;color:#aaa;font-weight:600}
.br .track{flex:1;height:34px;background:#1e1e35;border-radius:8px;overflow:hidden}
.br .fill{height:100%;border-radius:8px;display:flex;align-items:center;padding-left:12px;font-size:.85em;font-weight:800;color:#fff;animation:barGrow .8s ease backwards;transition:width .5s ease}
.br .val{min-width:50px;text-align:right;font-size:1em;font-weight:800;color:#fff}

/* Sensor */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sbox{background:#1e1e35;border-radius:12px;padding:16px;text-align:center;transition:transform .2s,background .2s}
.sbox:hover{transform:translateY(-2px);background:#252540}
.sbox .icon{font-size:1.6em;margin-bottom:4px}
.sbox .n{font-size:2.6em;font-weight:900;color:#fff;transition:all .5s}
.sbox .l{font-size:.75em;color:#888;margin-top:4px;font-weight:600}

/* Daily */
.daily{display:flex;align-items:flex-end;gap:8px;height:170px;padding-top:10px}
.dcol{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.dcol .n{font-size:1.1em;font-weight:800;color:#fff;opacity:0;animation:fadeUp .4s ease forwards}
.dcol:nth-child(1) .n{animation-delay:.1s}.dcol:nth-child(2) .n{animation-delay:.2s}.dcol:nth-child(3) .n{animation-delay:.3s}
.dcol .bar{width:100%;border-radius:8px 8px 0 0;min-height:8px;transition:height .6s ease}
.dcol .d{font-size:.78em;color:#888;font-weight:600}

/* Timeline */
.tlw{height:200px}.tlw canvas{width:100%;height:100%}

/* Events */
.evl{max-height:450px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#1e1e35 transparent}
.evi{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #1e1e35;transition:background .2s}
.evi:hover{background:#1e1e35;margin:0 -20px;padding:10px 20px;border-radius:8px}
.evi:last-child{border:none}
.evi .t{font-family:'Cascadia Code',monospace;font-size:.85em;color:#888;min-width:55px;font-weight:600}
.evi .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.evi .dot.ok{background:#22c55e;box-shadow:0 0 6px #22c55e66}
.evi .dot.err{background:#ef4444;box-shadow:0 0 6px #ef444466}
.evi .badge{padding:3px 10px;border-radius:6px;font-size:.75em;font-weight:800;min-width:68px;text-align:center;color:#fff}
.evi .ev{flex:1;font-size:.88em;color:#ccc}
.b-KERNEL{background:#7c3aed}.b-COMMS{background:#2563eb}.b-TOOL{background:#16a34a}.b-MEM{background:#ea580c}.b-SEC{background:#dc2626}.b-UNKNOWN{background:#444}

/* Strategy */
.si{padding:12px 0;border-bottom:1px solid #1e1e35;animation:slideIn .4s ease backwards}
.si:last-child{border:none}
.si .hd{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.si .dt{font-size:.78em;color:#888;font-weight:600}
.si .tag{font-size:.72em;padding:3px 10px;border-radius:6px;font-weight:800;color:#fff}
.si .tag.r{background:#7c3aed}.si .tag.hi{background:#ef4444}.si .tag.lo{background:#333;color:#888}
.si .txt{font-size:.88em;color:#ccc;line-height:1.6}

/* Exec */
.egrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px}
.ebox{background:#1e1e35;border-radius:10px;padding:14px;text-align:center;transition:transform .2s}
.ebox:hover{transform:translateY(-2px)}
.ebox .n{font-size:1.8em;font-weight:900;color:#fff}
.ebox .l{font-size:.68em;color:#888;margin-top:2px;font-weight:600}

/* Update flash */
.flash{animation:pulse .3s ease}

footer{text-align:center;color:#444;font-size:.75em;margin-top:30px;padding:20px}
footer a{color:#c4b5fd;text-decoration:none}
footer a:hover{text-decoration:underline}

@media(max-width:1000px){.g4,.g3{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.g4,.g3,.g2{grid-template-columns:1fr}body{padding:12px}.num-block .n{font-size:2.8em}}
</style>
</head>
<body>

<div class="header">
  <span class="logo">ğŸ¾</span>
  <h1>AIOS Dashboard</h1>
  <div class="header-right">
    <div class="time" id="ts">â€”</div>
    <div class="refresh-info">
      <span class="refresh-dot" id="rdot"></span>
      <span class="refresh-spinner" id="rspinner"></span>
      <span id="refresh-text">å®æ—¶ Â· 30såˆ·æ–°</span>
    </div>
  </div>
</div>

<div class="grid g4">
  <div class="card">
    <h2><span class="icon">ğŸ“Š</span> è¿›åŒ–åˆ†æ•°</h2>
    <div class="num-block" id="score-block"><div class="n" id="score">â€”</div><div class="l" id="grade">â€”</div></div>
    <div class="prog"><div class="prog-fill" id="pfill"></div></div>
  </div>
  <div class="card">
    <h2><span class="icon">ğŸ”§</span> å·¥å…·æˆåŠŸç‡</h2>
    <div class="num-block" id="tsr-block"><div class="n" id="tsr">â€”</div><div class="l">TSR</div></div>
    <div class="sub">ç›®æ ‡ â‰¥ 95%</div>
  </div>
  <div class="card">
    <h2><span class="icon">âœï¸</span> çº æ­£ç‡</h2>
    <div class="num-block" id="cr-block"><div class="n" id="cr">â€”</div><div class="l">CR</div></div>
    <div class="sub">ç›®æ ‡ â‰¤ 10%</div>
  </div>
  <div class="card">
    <h2><span class="icon">âš¡</span> 24H äº‹ä»¶</h2>
    <div class="num-block purple"><div class="n" id="ev24">â€”</div><div class="l">Total Events</div></div>
    <div class="sub" id="sevl">â€”</div>
  </div>
</div>

<div class="grid g3">
  <div class="card"><h2><span class="icon">ğŸš¨</span> ä¸¥é‡åº¦åˆ†å¸ƒ</h2><div class="bars" id="sev"></div></div>
  <div class="card"><h2><span class="icon">ğŸ“¡</span> äº‹ä»¶å±‚åˆ†å¸ƒ</h2><div class="bars" id="lay"></div></div>
  <div class="card"><h2><span class="icon">ğŸ‘ï¸</span> æ„ŸçŸ¥å±‚</h2>
    <div class="sgrid">
      <div class="sbox"><div class="icon">ğŸ“</div><div class="n" id="sf">â€”</div><div class="l">æ–‡ä»¶ç›‘æ§</div></div>
      <div class="sbox"><div class="icon">âš™ï¸</div><div class="n" id="sp">â€”</div><div class="l">è¿›ç¨‹ç›‘æ§</div></div>
      <div class="sbox"><div class="icon">â„ï¸</div><div class="n" id="sc">â€”</div><div class="l">å†·å´ä¸­</div></div>
      <div class="sbox"><div class="icon">ğŸŒ</div><div class="n" id="sn">â€”</div><div class="l">ç½‘ç»œæ¢é’ˆ</div></div>
    </div>
  </div>
</div>

<div class="grid g2">
  <div class="card"><h2><span class="icon">ğŸ“…</span> æ¯æ—¥äº‹ä»¶é‡</h2><div class="daily" id="daily"></div></div>
  <div class="card"><h2><span class="icon">ğŸ“ˆ</span> è¿›åŒ–è¶‹åŠ¿</h2><div class="tlw"><canvas id="cv"></canvas></div></div>
</div>

<!-- v0.6/v0.7 Reactor + Evolution v2 -->
<div class="grid g3">
  <div class="card">
    <h2><span class="icon">âš¡</span> Reactor è‡ªåŠ¨å“åº”</h2>
    <div class="sgrid">
      <div class="sbox"><div class="icon">ğŸ¯</div><div class="n" id="rx-exec">â€”</div><div class="l">è‡ªåŠ¨æ‰§è¡Œç‡</div></div>
      <div class="sbox"><div class="icon">âœ…</div><div class="n" id="rx-verify">â€”</div><div class="l">éªŒè¯é€šè¿‡ç‡</div></div>
      <div class="sbox"><div class="icon">ğŸ“Š</div><div class="n" id="rx-total">â€”</div><div class="l">æ€»å“åº”</div></div>
      <div class="sbox" id="rx-fuse-box"><div class="icon">ğŸ”’</div><div class="n" id="rx-fuse">â€”</div><div class="l">ç†”æ–­çŠ¶æ€</div></div>
    </div>
    <div class="evl" id="rx-history" style="max-height:160px;margin-top:10px"></div>
  </div>
  <div class="card">
    <h2><span class="icon">ğŸ§¬</span> Evolution v2</h2>
    <div class="num-block" id="evo2-block"><div class="n" id="evo2-score">â€”</div><div class="l" id="evo2-grade">â€”</div></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <div style="flex:1;text-align:center"><div style="font-size:.75em;color:#888">åŸºç¡€åˆ†</div><div style="font-size:1.4em;font-weight:800;color:#c4b5fd" id="evo2-base">â€”</div></div>
      <div style="flex:1;text-align:center"><div style="font-size:.75em;color:#888">Reactoråˆ†</div><div style="font-size:1.4em;font-weight:800;color:#22c55e" id="evo2-reactor">â€”</div></div>
    </div>
    <div style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;font-size:.78em;color:#888;margin-bottom:4px"><span>è‡ªåŠ¨ä¿®å¤ç‡</span><span id="evo2-fix">â€”</span></div>
      <div style="display:flex;justify-content:space-between;font-size:.78em;color:#888;margin-bottom:4px"><span>è¯¯æŠ¥ç‡</span><span id="evo2-fp">â€”</span></div>
      <div style="display:flex;justify-content:space-between;font-size:.78em;color:#888"><span>è‡ªåŠ¨å…³é—­ç‡</span><span id="evo2-close">â€”</span></div>
    </div>
  </div>
  <div class="card">
    <h2><span class="icon">ğŸ”„</span> Pipeline è¿è¡Œ</h2>
    <div class="sgrid">
      <div class="sbox"><div class="icon">ğŸƒ</div><div class="n" id="pl-runs">â€”</div><div class="l">æ€»è¿è¡Œ</div></div>
      <div class="sbox"><div class="icon">â±ï¸</div><div class="n" id="pl-last-ms">â€”</div><div class="l">æœ€è¿‘è€—æ—¶(ms)</div></div>
    </div>
    <div class="evl" id="pl-history" style="max-height:160px;margin-top:10px"></div>
  </div>
</div>

<!-- Playbook æˆåŠŸç‡ -->
<div class="grid g3">
  <div class="card" style="grid-column:span 3">
    <h2><span class="icon">ğŸ“‹</span> å‰§æœ¬æˆåŠŸç‡</h2>
    <div class="bars" id="pb-bars"></div>
  </div>
</div>

<div class="grid g2">
  <div class="card"><h2><span class="icon">ğŸ”„</span> æœ€è¿‘äº‹ä»¶æµ</h2><div class="evl" id="evl"></div></div>
  <div class="card"><h2><span class="icon">ğŸ§ </span> ç­–ç•¥å¼•æ“</h2><div id="str"></div><h2 style="margin-top:16px"><span class="icon">âš¡</span> æ‰§è¡Œå™¨</h2><div class="egrid" id="exc"></div></div>
</div>

<div class="grid g3">
  <div class="card">
    <h2><span class="icon">ğŸ“‹</span> ä»»åŠ¡çœ‹æ¿</h2>
    <div class="sgrid">
      <div class="sbox"><div class="icon">ğŸ“</div><div class="n" id="tk-todo">â€”</div><div class="l">å¾…åŠ</div></div>
      <div class="sbox"><div class="icon">ğŸ”„</div><div class="n" id="tk-prog">â€”</div><div class="l">è¿›è¡Œä¸­</div></div>
      <div class="sbox"><div class="icon">ğŸš«</div><div class="n" id="tk-block">â€”</div><div class="l">é˜»å¡</div></div>
      <div class="sbox"><div class="icon">âœ…</div><div class="n" id="tk-done">â€”</div><div class="l">å®Œæˆ</div></div>
    </div>
    <div class="sub" id="tk-overdue"></div>
    <div class="evl" id="tk-list" style="max-height:200px;margin-top:10px"></div>
  </div>
  <div class="card">
    <h2><span class="icon">ğŸ’°</span> èµ„æºé¢„ç®—</h2>
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;font-size:.85em;color:#aaa;margin-bottom:4px"><span>ä»Šæ—¥ Token</span><span id="bud-daily-txt">â€”</span></div>
      <div class="prog"><div class="prog-fill" id="bud-daily-bar" style="background:#22c55e"></div></div>
    </div>
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;font-size:.85em;color:#aaa;margin-bottom:4px"><span>æœ¬å‘¨ Token</span><span id="bud-weekly-txt">â€”</span></div>
      <div class="prog"><div class="prog-fill" id="bud-weekly-bar" style="background:#3b82f6"></div></div>
    </div>
    <div class="sgrid" style="margin-top:12px">
      <div class="sbox"><div class="icon">â±ï¸</div><div class="n" id="bud-hb-avg">â€”</div><div class="l">å¿ƒè·³å‡è€—(s)</div></div>
      <div class="sbox"><div class="icon">ğŸ’“</div><div class="n" id="bud-hb-cnt">â€”</div><div class="l">å¿ƒè·³æ¬¡æ•°</div></div>
    </div>
  </div>
  <div class="card">
    <h2><span class="icon">ğŸ¯</span> å†³ç­–å®¡è®¡</h2>
    <div class="sgrid">
      <div class="sbox"><div class="icon">ğŸ“Š</div><div class="n" id="dec-total">â€”</div><div class="l">æ€»å†³ç­–</div></div>
      <div class="sbox"><div class="icon">âœ…</div><div class="n" id="dec-rate">â€”</div><div class="l">æˆåŠŸç‡</div></div>
      <div class="sbox"><div class="icon">ğŸ¯</div><div class="n" id="dec-conf">â€”</div><div class="l">å¹³å‡ä¿¡å¿ƒ</div></div>
      <div class="sbox"><div class="icon">â³</div><div class="n" id="dec-pend">â€”</div><div class="l">å¾…éªŒè¯</div></div>
    </div>
    <div class="evl" id="dec-list" style="max-height:180px;margin-top:10px"></div>
  </div>
</div>

<footer>AIOS v0.7 Â· å°ä¹æ§åˆ¶å° Â· <a href="https://github.com/yangfei222666-9/aios">GitHub</a> Â· æŒ‰ R æ‰‹åŠ¨åˆ·æ–°</footer>

<script>
let lastData=null,cd=30,refreshing=false,wsConnected=false,ws=null;

// â”€â”€ WebSocket è¿æ¥ â”€â”€
function connectWS(){
  try{
    ws=new WebSocket('ws://127.0.0.1:9091');
    ws.onopen=()=>{
      wsConnected=true;
      document.getElementById('rdot').style.background='#22c55e';
      document.getElementById('refresh-text').textContent='å®æ—¶ Â· WebSocket';
    };
    ws.onmessage=(e)=>{
      try{
        const msg=JSON.parse(e.data);
        if(msg.type==='full'||msg.type==='update'){
          const d=msg.data;
          const changed=!lastData||JSON.stringify(d.overview)!==JSON.stringify(lastData.overview);
          R(d,changed);
          lastData=d;
          // é—ªçƒæŒ‡ç¤ºæ”¶åˆ°æ•°æ®
          const dot=document.getElementById('rdot');
          dot.style.background='#c4b5fd';
          setTimeout(()=>dot.style.background='#22c55e',300);
        }
      }catch(err){}
    };
    ws.onclose=()=>{
      wsConnected=false;
      document.getElementById('rdot').style.background='#eab308';
      document.getElementById('refresh-text').textContent='WebSocket æ–­å¼€ Â· è½®è¯¢ä¸­';
      setTimeout(connectWS,5000);
    };
    ws.onerror=()=>{ws.close()};
  }catch(e){
    wsConnected=false;
  }
}
connectWS();

function refresh(){
  if(wsConnected)return; // WebSocket è¿æ¥æ—¶ä¸è½®è¯¢
  refreshing=true;
  document.getElementById('rdot').style.display='none';
  document.getElementById('rspinner').style.display='inline-block';
  document.getElementById('refresh-text').textContent='åˆ·æ–°ä¸­...';
  
  fetch('dashboard_data.json?t='+Date.now())
    .then(r=>r.json())
    .then(d=>{
      const changed=!lastData||JSON.stringify(d.overview)!==JSON.stringify(lastData.overview);
      R(d,changed);
      lastData=d;
      cd=30;
      refreshing=false;
      document.getElementById('rdot').style.display='inline-block';
      document.getElementById('rspinner').style.display='none';
      if(!wsConnected)document.getElementById('refresh-text').textContent='HTTPè½®è¯¢ Â· '+cd+'s';
    })
    .catch(()=>{
      refreshing=false;
      document.getElementById('rdot').style.display='inline-block';
      document.getElementById('rspinner').style.display='none';
      document.getElementById('refresh-text').textContent='è¿æ¥å¤±è´¥ Â· é‡è¯•ä¸­';
    });
}

refresh();
setInterval(()=>{if(!wsConnected)refresh()},30000);
setInterval(()=>{
  if(!refreshing&&!wsConnected){
    cd--;if(cd<=0)cd=30;
    document.getElementById('refresh-text').textContent='HTTPè½®è¯¢ Â· '+cd+'s ååˆ·æ–°';
  }
},1000);

// æŒ‰ R æ‰‹åŠ¨åˆ·æ–°
document.addEventListener('keydown',e=>{
  if(e.key==='r'||e.key==='R'){
    if(wsConnected&&ws){ws.send('refresh')}
    else{cd=30;refresh()}
  }
});

function flash(el){el.classList.remove('flash');void el.offsetWidth;el.classList.add('flash')}

function R(d,changed){
  const o=d.overview;

  const scoreEl=document.getElementById('score');
  scoreEl.textContent=o.evolution_score.toFixed(2);
  document.getElementById('grade').textContent=o.grade.toUpperCase();
  document.getElementById('score-block').className='num-block '+(o.grade==='healthy'?'green':o.grade==='degraded'?'yellow':'red');
  if(changed)flash(document.getElementById('score-block'));
  const pf=document.getElementById('pfill');
  pf.style.width=Math.min(o.evolution_score/.5*100,100)+'%';
  pf.style.background=o.grade==='healthy'?'#22c55e':'#eab308';

  const tv=o.tsr*100;
  document.getElementById('tsr').textContent=tv.toFixed(0)+'%';
  const tb=document.getElementById('tsr-block');
  tb.className='num-block '+(tv>=95?'green':tv>=80?'yellow':'red');
  if(changed)flash(tb);

  const cv=o.correction_rate*100;
  document.getElementById('cr').textContent=cv.toFixed(0)+'%';
  const cb=document.getElementById('cr-block');
  cb.className='num-block '+(cv<=10?'green':cv<=25?'yellow':'red');
  if(changed)flash(cb);

  document.getElementById('ev24').textContent=o.total_events_24h;
  const sv=o.severity||{};
  document.getElementById('sevl').innerHTML='CRIT:'+(sv.CRIT||0)+' Â· WARN:'+(sv.WARN||0)+' Â· INFO:'+(sv.INFO||0);

  document.getElementById('sf').textContent=d.sensors.file_watches;
  document.getElementById('sp').textContent=d.sensors.running_procs;
  document.getElementById('sc').textContent=d.sensors.cooldowns_active;
  document.getElementById('sn').textContent=d.sensors.network_probes;

  bars('sev',d.events.by_severity,['CRIT','ERR','WARN','INFO'],{CRIT:'#ef4444',ERR:'#b91c1c',WARN:'#eab308',INFO:'#3b82f6'});
  bars('lay',d.events.by_layer,['KERNEL','COMMS','TOOL','MEM','SEC','UNKNOWN'],{KERNEL:'#7c3aed',COMMS:'#2563eb',TOOL:'#16a34a',MEM:'#ea580c',SEC:'#dc2626',UNKNOWN:'#444'});
  mkDaily(d.events.daily);
  mkTL(d.timeline);
  mkEv(d.events.recent);
  mkStr(d.strategies);
  mkExc(d.execution);
  document.getElementById('ts').textContent=d.generated_at.replace('T',' ').slice(0,19);

  // v0.5 æ–°æ¨¡å—
  if(d.tasks)mkTasks(d.tasks);
  if(d.budget)mkBudget(d.budget);
  if(d.decisions)mkDecisions(d.decisions);

  // v0.6/v0.7 æ–°æ¨¡å—
  if(d.reactor)mkReactor(d.reactor);
  if(d.evolution_v2)mkEvo2(d.evolution_v2);
  if(d.pipeline)mkPipeline(d.pipeline);
}

function bars(id,data,order,colors){
  const el=document.getElementById(id),mx=Math.max(...order.map(k=>data[k]||0),1);
  let h='';
  order.forEach((k,i)=>{
    const v=data[k]||0,p=Math.max(v/mx*100,v>0?8:0),c=colors[k];
    h+='<div class="br" style="animation-delay:'+(.1+i*.05)+'s"><span class="name">'+k+'</span><div class="track"><div class="fill" style="width:'+p+'%;background:'+c+';animation-delay:'+(.2+i*.08)+'s">'+(v>0&&p>15?v:'')+'</div></div><span class="val">'+v+(v===0&&(k==='CRIT'||k==='ERR')?' âœ…':'')+'</span></div>';
  });
  el.innerHTML=h;
}

function mkDaily(dd){
  const el=document.getElementById('daily'),ks=Object.keys(dd),vs=Object.values(dd),mx=Math.max(...vs,1);
  const cs=['#7c3aed','#3b82f6','#22c55e','#ea580c','#ef4444','#eab308','#c084fc'];
  let h='';
  ks.forEach((k,i)=>{const ht=Math.max(vs[i]/mx*140,10);h+='<div class="dcol"><div class="n" style="animation-delay:'+(.1+i*.1)+'s">'+vs[i]+'</div><div class="bar" style="height:'+ht+'px;background:linear-gradient(180deg,'+cs[i%cs.length]+','+cs[i%cs.length]+'88)"></div><div class="d">'+k.slice(5)+'</div></div>'});
  el.innerHTML=h;
}

function mkTL(tl){
  const c=document.getElementById('cv'),ctx=c.getContext('2d'),dpr=devicePixelRatio||1;
  c.width=c.offsetWidth*dpr;c.height=c.offsetHeight*dpr;ctx.scale(dpr,dpr);
  const w=c.offsetWidth,h=c.offsetHeight,p={t:20,b:35,l:50,r:15},pw=w-p.l-p.r,ph=h-p.t-p.b;
  if(tl.length<2){ctx.fillStyle='#888';ctx.font='14px sans-serif';ctx.fillText('æ•°æ®ç§¯ç´¯ä¸­...',w/2-40,h/2);return}
  const ss=tl.map(t=>t.score),mn=Math.min(...ss)-.05,mx=Math.max(...ss)+.05;
  for(let i=0;i<=4;i++){const y=p.t+ph/4*i;ctx.strokeStyle='#1e1e35';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(p.l,y);ctx.lineTo(w-p.r,y);ctx.stroke();ctx.fillStyle='#888';ctx.font='bold 11px monospace';ctx.fillText((mx-(mx-mn)*i/4).toFixed(2),2,y+4)}
  const g=ctx.createLinearGradient(0,p.t,0,p.t+ph);g.addColorStop(0,'rgba(139,92,246,.35)');g.addColorStop(1,'rgba(139,92,246,.02)');
  ctx.fillStyle=g;ctx.beginPath();tl.forEach((t,i)=>{const x=p.l+pw/(tl.length-1)*i,y=p.t+ph-((ss[i]-mn)/(mx-mn))*ph;i?ctx.lineTo(x,y):ctx.moveTo(x,y)});ctx.lineTo(p.l+pw,p.t+ph);ctx.lineTo(p.l,p.t+ph);ctx.closePath();ctx.fill();
  ctx.strokeStyle='#c4b5fd';ctx.lineWidth=2.5;ctx.beginPath();tl.forEach((t,i)=>{const x=p.l+pw/(tl.length-1)*i,y=p.t+ph-((ss[i]-mn)/(mx-mn))*ph;i?ctx.lineTo(x,y):ctx.moveTo(x,y)});ctx.stroke();
  tl.forEach((t,i)=>{const x=p.l+pw/(tl.length-1)*i,y=p.t+ph-((ss[i]-mn)/(mx-mn))*ph;ctx.fillStyle='#c4b5fd33';ctx.beginPath();ctx.arc(x,y,10,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();if(i===0||i===tl.length-1||i%Math.max(1,Math.floor(tl.length/5))===0){ctx.fillStyle='#fff';ctx.font='bold 12px sans-serif';ctx.fillText(ss[i].toFixed(2),x-14,y-14)}});
  ctx.fillStyle='#666';ctx.font='bold 10px monospace';const st=Math.max(1,Math.floor(tl.length/6));for(let i=0;i<tl.length;i+=st){const x=p.l+pw/(tl.length-1)*i;ctx.fillText((tl[i].ts||'').slice(5,16).replace('T',' '),x-22,h-8)}
}

function mkEv(ev){
  const el=document.getElementById('evl');
  if(!ev.length){el.innerHTML='<div style="color:#666;padding:30px;text-align:center">æš‚æ— äº‹ä»¶</div>';return}
  let h='';[...ev].reverse().forEach(e=>{h+='<div class="evi"><span class="t">'+(e.ts||'').slice(11,16)+'</span><span class="dot '+(e.status==='ok'?'ok':'err')+'"></span><span class="badge b-'+(e.layer||'UNKNOWN')+'">'+(e.layer||'?')+'</span><span class="ev">'+(e.event||'â€”')+'</span></div>'});
  el.innerHTML=h;
}

function mkStr(ss){
  const el=document.getElementById('str');
  if(!ss.length){el.innerHTML='<div style="color:#666;padding:16px 0">æš‚æ— ç­–ç•¥</div>';return}
  let h='';[...ss].reverse().forEach((s,i)=>{h+='<div class="si" style="animation-delay:'+(.1+i*.08)+'s"><div class="hd"><span class="dt">'+s.date+'</span><span class="tag r">'+s.rule+'</span><span class="tag '+(s.priority==='high'?'hi':'lo')+'">'+s.priority+'</span></div><div class="txt">'+s.content+'</div></div>'});
  el.innerHTML=h;
}

function mkExc(ex){
  const el=document.getElementById('exc');
  let h='<div class="ebox"><div class="n">'+ex.total+'</div><div class="l">æ€»æ‰§è¡Œ</div></div>';
  for(const[k,v]of Object.entries(ex.terminal_states))h+='<div class="ebox"><div class="n">'+v+'</div><div class="l">'+k.replace(/_/g,' ')+'</div></div>';
  el.innerHTML=h;
}

function mkTasks(tk){
  document.getElementById('tk-todo').textContent=tk.todo;
  document.getElementById('tk-prog').textContent=tk.in_progress;
  document.getElementById('tk-block').textContent=tk.blocked;
  document.getElementById('tk-done').textContent=tk.done;
  const od=document.getElementById('tk-overdue');
  od.innerHTML=tk.overdue>0?'âš ï¸ '+tk.overdue+' ä¸ªä»»åŠ¡å·²è¿‡æœŸ':'âœ… æ— è¿‡æœŸä»»åŠ¡';
  od.style.color=tk.overdue>0?'#ef4444':'#22c55e';
  const el=document.getElementById('tk-list');
  if(!tk.recent||!tk.recent.length){el.innerHTML='<div style="color:#666;padding:10px;text-align:center">æ— æ´»è·ƒä»»åŠ¡</div>';return}
  let h='';
  const sIcon={'TODO':'ğŸ“','IN_PROGRESS':'ğŸ”„','BLOCKED':'ğŸš«','DONE':'âœ…'};
  const pColor={'P0':'#ef4444','P1':'#eab308','P2':'#3b82f6','P3':'#666'};
  tk.recent.forEach(t=>{
    h+='<div class="evi"><span class="t">'+(t.deadline||'â€”')+'</span><span style="color:'+(pColor[t.priority]||'#888')+';font-weight:800;font-size:.8em;min-width:28px">'+t.priority+'</span><span class="ev">'+(sIcon[t.status]||'â“')+' '+t.title+'</span></div>';
  });
  el.innerHTML=h;
}

function mkBudget(b){
  const dp=Math.min(b.daily_pct,100),wp=Math.min(b.weekly_pct,100);
  document.getElementById('bud-daily-txt').textContent=b.daily_used.toLocaleString()+'/'+b.daily_budget.toLocaleString()+' ('+b.daily_pct+'%)';
  document.getElementById('bud-weekly-txt').textContent=b.weekly_used.toLocaleString()+'/'+b.weekly_budget.toLocaleString()+' ('+b.weekly_pct+'%)';
  const db=document.getElementById('bud-daily-bar');
  db.style.width=Math.max(dp,2)+'%';
  db.style.background=dp>80?'#ef4444':dp>50?'#eab308':'#22c55e';
  const wb=document.getElementById('bud-weekly-bar');
  wb.style.width=Math.max(wp,2)+'%';
  wb.style.background=wp>80?'#ef4444':wp>50?'#eab308':'#3b82f6';
  document.getElementById('bud-hb-avg').textContent=b.heartbeat_avg;
  document.getElementById('bud-hb-cnt').textContent=b.heartbeat_count;
}

function mkDecisions(dc){
  document.getElementById('dec-total').textContent=dc.total;
  document.getElementById('dec-rate').textContent=dc.success_rate+'%';
  document.getElementById('dec-conf').textContent=dc.avg_confidence+'%';
  document.getElementById('dec-pend').textContent=(dc.outcomes||{}).pending||0;
  const el=document.getElementById('dec-list');
  if(!dc.recent||!dc.recent.length){el.innerHTML='<div style="color:#666;padding:10px;text-align:center">æ— å†³ç­–è®°å½•</div>';return}
  let h='';
  const oIcon={'success':'âœ…','fail':'âŒ','pending':'â³'};
  dc.recent.forEach(d=>{
    const conf=Math.round((d.confidence||0)*100);
    h+='<div class="evi"><span class="t">'+(d.ts||'').slice(11,16)+'</span><span style="font-size:.85em">'+(oIcon[d.outcome]||'â“')+'</span><span class="ev">'+d.context+' â†’ <b>'+d.chosen+'</b> <span style="color:#888;font-size:.8em">'+conf+'%</span></span></div>';
  });
  el.innerHTML=h;
}

function mkReactor(rx){
  document.getElementById('rx-exec').textContent=rx.auto_exec_rate+'%';
  document.getElementById('rx-verify').textContent=rx.verify_rate+'%';
  document.getElementById('rx-total').textContent=rx.total;
  const fuseBox=document.getElementById('rx-fuse-box');
  if(rx.fuse_tripped){
    document.getElementById('rx-fuse').textContent='ğŸ”´';
    fuseBox.style.background='#3b1111';
  }else{
    document.getElementById('rx-fuse').textContent='ğŸŸ¢';
    fuseBox.style.background='';
  }
  // å†å²
  const el=document.getElementById('rx-history');
  if(!rx.recent||!rx.recent.length){el.innerHTML='<div style="color:#666;padding:10px;text-align:center">æ— å“åº”è®°å½•</div>';return}
  let h='';
  const sIcon={'success':'âœ…','pending_confirm':'âš ï¸','partial_failure':'âŒ','no_match':'â­ï¸'};
  [...rx.recent].reverse().forEach(r=>{
    h+='<div class="evi"><span class="t">'+(r.ts||'').slice(11,16)+'</span><span style="font-size:.85em">'+(sIcon[r.status]||'â“')+'</span><span class="ev">['+r.pb+'] â†’ '+r.status+'</span></div>';
  });
  el.innerHTML=h;
  // å‰§æœ¬æˆåŠŸç‡
  const pbEl=document.getElementById('pb-bars');
  if(!rx.playbooks||!rx.playbooks.length){pbEl.innerHTML='<div style="color:#666;padding:10px;text-align:center">æ— å‰§æœ¬æ•°æ®</div>';return}
  const mx=Math.max(...rx.playbooks.map(p=>p.total),1);
  let bh='';
  rx.playbooks.forEach((p,i)=>{
    const pct=p.total>0?Math.max(p.rate/100*100,8):0;
    const c=p.rate>=80?'#22c55e':p.rate>=50?'#eab308':'#ef4444';
    bh+='<div class="br" style="animation-delay:'+(.1+i*.05)+'s"><span class="name">'+p.id.replace(/_/g,' ')+'</span><div class="track"><div class="fill" style="width:'+pct+'%;background:'+c+'">'+(p.total>0?p.rate+'%':'')+'</div></div><span class="val">'+p.success+'/'+p.total+'</span></div>';
  });
  pbEl.innerHTML=bh;
}

function mkEvo2(ev){
  document.getElementById('evo2-score').textContent=ev.v2_score.toFixed(2);
  document.getElementById('evo2-grade').textContent=ev.grade.toUpperCase();
  const block=document.getElementById('evo2-block');
  block.className='num-block '+(ev.grade==='healthy'?'green':ev.grade==='degraded'?'yellow':'red');
  document.getElementById('evo2-base').textContent=ev.base.toFixed(2);
  document.getElementById('evo2-reactor').textContent=ev.reactor.toFixed(2);
  const d=ev.detail||{};
  document.getElementById('evo2-fix').textContent=((d.auto_fix_rate||0)*100).toFixed(0)+'%';
  document.getElementById('evo2-fp').textContent=((d.false_positive_rate||0)*100).toFixed(0)+'%';
  document.getElementById('evo2-close').textContent=((d.auto_close_rate||0)*100).toFixed(0)+'%';
}

function mkPipeline(pl){
  document.getElementById('pl-runs').textContent=pl.total_runs;
  const last=pl.recent&&pl.recent.length?pl.recent[pl.recent.length-1]:null;
  document.getElementById('pl-last-ms').textContent=last?last.ms:'â€”';
  const el=document.getElementById('pl-history');
  if(!pl.recent||!pl.recent.length){el.innerHTML='<div style="color:#666;padding:10px;text-align:center">æ— è¿è¡Œè®°å½•</div>';return}
  let h='';
  const gIcon={'healthy':'ğŸŸ¢','degraded':'ğŸŸ¡','critical':'ğŸ”´'};
  [...pl.recent].reverse().forEach(r=>{
    h+='<div class="evi"><span class="t">'+(r.ts||'').slice(11,16)+'</span><span style="font-size:.85em">'+(gIcon[r.grade]||'âšª')+'</span><span class="ev">'+r.ms+'ms'+(r.errors>0?' Â· âš ï¸'+r.errors+'é”™è¯¯':'')+'</span></div>';
  });
  el.innerHTML=h;
}
</script>
</body>
</html>
