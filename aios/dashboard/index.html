<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOS æ§åˆ¶å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e6ed;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1729 100%);
            padding: 20px 40px;
            border-bottom: 1px solid #1e2847;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 600;
        }

        .logo-icon {
            font-size: 32px;
        }

        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 14px;
            color: #8b92a7;
        }

        .container {
            padding: 30px 40px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .top-cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .top-cards > .evolution-card {
            grid-column: span 1;
        }

        .big-card {
            background: linear-gradient(135deg, #1e2847 0%, #151b33 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #2a3555;
            position: relative;
            cursor: help;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .big-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .card-tooltip {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
        }

        .big-card:hover .card-tooltip {
            opacity: 1;
        }

        .big-number {
            font-size: 42px;
            font-weight: 700;
            margin: 8px 0;
        }

        .big-label {
            font-size: 12px;
            color: #8b92a7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-healthy { background: #10b981; color: #fff; }
        .status-degraded { background: #f59e0b; color: #fff; }
        .status-critical { background: #ef4444; color: #fff; }
        .status-warning { background: #f59e0b; color: #fff; }
        .status-idle { background: #6b7280; color: #fff; }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #1e2847 0%, #151b33 100%);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #2a3555;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 600;
        }

        .card-icon {
            font-size: 20px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .evolution-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            text-align: center;
            padding: 20px;
        }

        .evolution-score {
            font-size: 48px;
            font-weight: 700;
            margin: 8px 0;
        }

        .evolution-grade {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .evolution-breakdown {
            display: none;
        }

        .evolution-item {
            text-align: left;
        }

        .evolution-item-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .evolution-item-value {
            font-size: 22px;
            font-weight: 700;
        }

        .reactor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .reactor-stat {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .reactor-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .reactor-value {
            font-size: 48px;
            font-weight: 700;
            margin: 10px 0;
        }

        .reactor-label {
            font-size: 12px;
            color: #8b92a7;
            line-height: 1.4;
        }

        .pipeline-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pipeline-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .pipeline-time {
            color: #8b92a7;
            font-size: 14px;
        }

        .pipeline-duration {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .duration-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f59e0b;
        }

        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-message {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .alert-time {
            font-size: 12px;
            color: #8b92a7;
        }

        .event-stream {
            background: #0f1729;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .event-line {
            padding: 4px 0;
            border-bottom: 1px solid #1e2847;
        }

        .event-time {
            color: #6b7280;
            margin-right: 10px;
        }

        .event-layer {
            color: #3b82f6;
            margin-right: 10px;
        }

        .event-type {
            color: #10b981;
        }

        .no-data {
            text-align: center;
            color: #6b7280;
            padding: 40px;
            font-size: 14px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e2847;
        }

        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }

        /* Heartbeat Tasks Styles */
        .heartbeat-task {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid #3b82f6;
        }

        .heartbeat-task.overdue {
            border-left-color: #ef4444;
        }

        .heartbeat-task.never-run {
            border-left-color: #f59e0b;
        }

        .heartbeat-task-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .heartbeat-task-interval {
            font-size: 12px;
            color: #8b92a7;
            margin-bottom: 8px;
        }

        .heartbeat-task-status {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .heartbeat-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .heartbeat-status-dot.overdue {
            background: #ef4444;
        }

        .heartbeat-status-dot.never-run {
            background: #f59e0b;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <span class="logo-icon">ğŸ¤–</span>
            <span>AIOS æ§åˆ¶å°</span>
        </div>
        <div class="header-right">
            <button onclick="forceRefresh()" style="
                background: #3b82f6;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
            ">ğŸ”„ åˆ·æ–°</button>
            <span>æœ€åæ›´æ–°: <span id="last-update">--:--</span></span>
            <span id="connection-status">ğŸŸ¢ å°±ç»ª</span>
        </div>
    </div>

    <div class="container">
        <!-- Top Big Cards -->
        <div class="top-cards">
            <div class="big-card evolution-card">
                <div class="big-label">ç³»ç»Ÿè¿›åŒ–åˆ†æ•°</div>
                <div class="evolution-score" id="evolution-score">0.00</div>
                <div class="evolution-grade" id="evolution-grade">å¥åº·</div>
            </div>
                    </div>
                    <div class="evolution-item">
                        <div class="evolution-item-label">Reactoråˆ†ï¼ˆè‡ªåŠ¨ä¿®å¤èƒ½åŠ›ï¼‰</div>
                        <div class="evolution-item-value" id="evolution-reactor">0.00</div>
                    </div>
                    <div class="evolution-item">
                        <div class="evolution-item-label">è‡ªåŠ¨ä¿®å¤ç‡</div>
                        <div class="evolution-item-value" id="evolution-auto">0%</div>
                    </div>
                    <div class="evolution-item">
                        <div class="evolution-item-label">éªŒè¯é€šè¿‡ç‡</div>
                        <div class="evolution-item-value" id="evolution-verify">0%</div>
                    </div>
                </div>
            </div>
            <div class="big-card">
                <div class="big-label">ç³»ç»ŸçŠ¶æ€</div>
                <div class="big-number" id="system-status" style="font-size: 14px; margin: 12px 0;">ç©ºé—²</div>
                <div class="status-badge status-idle" id="status-badge">ç©ºé—²</div>
                
                <div style="margin-top: 15px; font-size: 11px; color: #8b92a7; text-align: left;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span>Provider:</span>
                        <span id="system-provider" style="color: #e0e6ed; font-weight: 600;">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span>ç†”æ–­å™¨:</span>
                        <span id="system-breaker" style="color: #10b981; font-weight: 600;">CLOSED</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>æœ€è¿‘å¿ƒè·³:</span>
                        <span id="system-heartbeat" style="font-weight: 600;">--</span>
                    </div>
                </div>
            </div>
            <div class="big-card">
                <div class="big-label">äº‹ä»¶ (1å°æ—¶)</div>
                <div class="big-number" id="events-1h">0</div>
                
                <div style="margin-top: 15px; font-size: 11px; color: #8b92a7; text-align: left;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span>é”™è¯¯äº‹ä»¶:</span>
                        <span id="events-errors" style="color: #ef4444; font-weight: 600;">0</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 10px;">
                        <div style="color: #8b92a7; margin-bottom: 5px;">Top3 ç±»å‹:</div>
                        <div id="events-top3" style="color: #e0e6ed; line-height: 1.6;">
                            <div style="opacity: 0.6;">æš‚æ— æ•°æ®</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="big-card">
                <div class="big-label">æ´»è·ƒ AGENT</div>
                <div class="big-number" id="active-agents">0</div>
                
                <div style="margin-top: 15px; font-size: 11px; color: #8b92a7; text-align: left;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span>Running / Waiting:</span>
                        <span id="agent-status" style="color: #e0e6ed; font-weight: 600;">0 / 0</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 10px;">
                        <div style="color: #8b92a7; margin-bottom: 5px;">å½“å‰ Agent:</div>
                        <div id="agent-current" style="color: #e0e6ed; line-height: 1.6;">
                            <div style="opacity: 0.6;">æ— </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="big-card">
                <div class="big-label">å¾…å¤„ç†å‘Šè­¦</div>
                <div class="big-number" id="pending-alerts">0</div>
                
                <div style="margin-top: 15px; font-size: 11px; color: #8b92a7; text-align: left;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span>CRIT / WARN:</span>
                        <span id="alert-breakdown" style="color: #e0e6ed; font-weight: 600;">0 / 0</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 10px;">
                        <div style="color: #8b92a7; margin-bottom: 5px;">è¶…æœŸå‘Šè­¦:</div>
                        <div id="alert-overdue" style="color: #ef4444; font-weight: 600;">
                            æ— 
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Heartbeat Tasks Widget -->
        <div style="
            background: linear-gradient(135deg, #1e2847 0%, #151b33 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a3555;
            margin-bottom: 20px;
        ">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #e0e6ed;">
                â±ï¸ å¿ƒè·³ä»»åŠ¡çŠ¶æ€
            </h3>
            <div id="heartbeat-tasks" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <!-- Tasks will be inserted here -->
            </div>
        </div>

        <!-- System Resources Row -->
        <div class="grid-3">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ’»</span>
                    <span>CPU ä½¿ç”¨ç‡</span>
                </div>
                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 48px; font-weight: 700; color: #3b82f6;" id="cpu-usage">0%</div>
                    <div style="font-size: 14px; color: #8b92a7; margin-top: 10px;">å¹³å‡è´Ÿè½½: <span id="cpu-load">0.0</span></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ®</span>
                    <span>GPU ä½¿ç”¨ç‡</span>
                </div>
                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 48px; font-weight: 700; color: #10b981;" id="gpu-usage">0%</div>
                    <div style="font-size: 14px; color: #8b92a7; margin-top: 10px;">æ¸©åº¦: <span id="gpu-temp">--</span>Â°C</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ’¾</span>
                    <span>å†…å­˜ä½¿ç”¨ç‡</span>
                </div>
                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 48px; font-weight: 700; color: #f59e0b;" id="memory-usage">0%</div>
                    <div style="font-size: 14px; color: #8b92a7; margin-top: 10px;"><span id="memory-used">0</span> / <span id="memory-total">0</span> GB</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span>æ¯æ—¥äº‹ä»¶é‡ï¼ˆæœ€è¿‘7å¤©ï¼‰</span>
                </div>
                <div class="chart-container">
                    <canvas id="events-chart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“ˆ</span>
                    <span>è¿›åŒ–è¶‹åŠ¿ï¼ˆåŸºçº¿åˆ† vs Reactoråˆ†ï¼‰</span>
                </div>
                <div class="chart-container">
                    <canvas id="evolution-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Middle Row: Scheduler & Reactor -->
        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ§ </span>
                    <span>SCHEDULER è°ƒåº¦æ€»è§ˆ</span>
                </div>
                <div class="reactor-grid">
                    <div class="reactor-stat">
                        <div class="reactor-icon">ğŸ“Š</div>
                        <div class="reactor-value" id="scheduler-decisions">0</div>
                        <div class="reactor-label">æ€»å†³ç­–æ•°ï¼ˆ1å°æ—¶ï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">âœ…</div>
                        <div class="reactor-value" id="scheduler-executed">0%</div>
                        <div class="reactor-label">æ‰§è¡Œç‡ï¼ˆå†³ç­–åå®é™…æ‰§è¡Œçš„æ¯”ä¾‹ï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">â±ï¸</div>
                        <div class="reactor-value" id="scheduler-latency">0</div>
                        <div class="reactor-label">å¹³å‡å»¶è¿Ÿï¼ˆmsï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">ğŸ¯</div>
                        <div class="reactor-value" id="scheduler-top-action">--</div>
                        <div class="reactor-label">æœ€å¸¸è§å†³ç­–</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">âš¡</span>
                    <span>REACTOR è‡ªåŠ¨å“åº”</span>
                </div>
                <div class="reactor-grid">
                    <div class="reactor-stat">
                        <div class="reactor-icon">ğŸ¯</div>
                        <div class="reactor-value" id="reactor-exec">0%</div>
                        <div class="reactor-label">è‡ªåŠ¨æ‰§è¡Œç‡ï¼ˆåŒ¹é…åè‡ªåŠ¨æ‰§è¡Œçš„æ¯”ä¾‹ï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">âœ…</div>
                        <div class="reactor-value" id="reactor-verify">0%</div>
                        <div class="reactor-label">éªŒè¯é€šè¿‡ç‡ï¼ˆæ‰§è¡ŒåéªŒè¯æˆåŠŸçš„æ¯”ä¾‹ï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">ğŸ“¦</div>
                        <div class="reactor-value" id="reactor-playbooks">0</div>
                        <div class="reactor-label">æ€»å‰§æœ¬æ•°ï¼ˆå¯ç”¨çš„è‡ªåŠ¨ä¿®å¤è§„åˆ™ï¼‰</div>
                    </div>
                    <div class="reactor-stat">
                        <div class="reactor-icon">ğŸ”’</div>
                        <div class="reactor-value" id="reactor-breakers">0</div>
                        <div class="reactor-label">ç†”æ–­å™¨ï¼ˆå½“å‰è§¦å‘ç†”æ–­çš„æ•°é‡ï¼‰</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline & Agent Row -->
        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ”„</span>
                    <span>PIPELINE è¿è¡Œå†å²ï¼ˆæœ€è¿‘10æ¬¡ï¼‰</span>
                </div>
                <div class="pipeline-list" id="pipeline-list">
                    <div class="no-data">æš‚æ— æ•°æ®</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ¤–</span>
                    <span>AGENT æ´»åŠ¨ï¼ˆæœ€è¿‘10æ¬¡ï¼‰</span>
                </div>
                <div class="pipeline-list" id="agent-activity-list">
                    <div class="no-data">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- Bottom Row -->
        <div class="grid-3">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">âš ï¸</span>
                    <span>å‘Šè­¦è¯¦æƒ…ï¼ˆæœ€è¿‘5æ¡ï¼‰</span>
                </div>
                <div class="alert-list" id="alert-list">
                    <div class="no-data">æš‚æ— å‘Šè­¦</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ”´</span>
                    <span>äº‹ä»¶æµï¼ˆå®æ—¶æ»šåŠ¨ï¼Œæœ€è¿‘20æ¡ï¼‰</span>
                    <div style="margin-left: auto; display: flex; gap: 8px;">
                        <button onclick="filterEvents('all')" id="filter-all" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 4px 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 10px;
                        ">å…¨éƒ¨</button>
                        <button onclick="filterEvents('error')" id="filter-error" style="
                            background: #374151;
                            color: white;
                            border: none;
                            padding: 4px 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 10px;
                        ">åªçœ‹é”™è¯¯</button>
                    </div>
                </div>
                <div class="event-stream" id="event-stream">
                    <div class="no-data">ç­‰å¾…äº‹ä»¶...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ› ï¸</span>
                    <span>å·¥å…·ä½¿ç”¨ç»Ÿè®¡ï¼ˆ1å°æ—¶ï¼‰</span>
                </div>
                <div id="tool-stats" style="padding: 15px;">
                    <div class="no-data">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- Additional Row -->
        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span>ç£ç›˜ä½¿ç”¨æƒ…å†µ</span>
                </div>
                <div id="disk-usage" style="padding: 20px;">
                    <div class="no-data">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸŒ</span>
                    <span>ç½‘ç»œçŠ¶æ€</span>
                </div>
                <div id="network-status" style="padding: 20px;">
                    <div class="no-data">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart.js é…ç½®
        Chart.defaults.color = '#8b92a7';
        Chart.defaults.borderColor = '#2a3555';

        let eventsChart, evolutionChart;
        let ws = null;
        let reconnectTimer = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æ¯æ—¥äº‹ä»¶é‡æŸ±çŠ¶å›¾
            const eventsCtx = document.getElementById('events-chart').getContext('2d');
            eventsChart = new Chart(eventsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'äº‹ä»¶æ•°',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#2a3555' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // è¿›åŒ–è¶‹åŠ¿æŠ˜çº¿å›¾
            const evolutionCtx = document.getElementById('evolution-chart').getContext('2d');
            evolutionChart = new Chart(evolutionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'åŸºçº¿åˆ†',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Reactoråˆ†',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            grid: { color: '#2a3555' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // æ›´æ–° Dashboard
        function updateDashboard(data) {
            // æ›´æ–°æ—¶é—´
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('zh-CN');

            // ç³»ç»Ÿå¥åº·
            const health = data.system_health || {};
            const eventsCount = health.events_1h || 0;
            const errorsCount = health.errors_1h || 0;
            const warningsCount = health.warnings_1h || 0;
            
            document.getElementById('events-1h').textContent = eventsCount;
            
            // ç³»ç»ŸçŠ¶æ€åˆ¤å®šè§„åˆ™
            const statusElement = document.getElementById('system-status');
            const statusBadge = document.getElementById('status-badge');
            
            let status = 'healthy';
            let statusText = 'å¥åº·';
            let statusDisplay = 'æ­£å¸¸';
            
            // åˆ¤å®šé€»è¾‘
            if (errorsCount > 10) {
                status = 'critical';
                statusText = 'ä¸¥é‡';
                statusDisplay = 'æ•…éšœ';
            } else if (errorsCount > 0 || warningsCount > 5) {
                status = 'warning';
                statusText = 'è­¦å‘Š';
                statusDisplay = 'å¼‚å¸¸';
            } else if (eventsCount === 0) {
                status = 'idle';
                statusText = 'ç©ºé—²';
                statusDisplay = 'ç©ºé—²';
            } else {
                status = 'healthy';
                statusText = 'å¥åº·';
                statusDisplay = 'æ­£å¸¸';
            }
            
            if (statusElement) {
                statusElement.textContent = statusDisplay;
            }
            
            if (statusBadge) {
                statusBadge.textContent = statusText;
                statusBadge.className = 'status-badge status-' + status;
            }

            // Agent çŠ¶æ€
            const agents = data.agents || {};
            
            console.log('Agent stats:', agents); // è°ƒè¯•æ—¥å¿—
            
            const activeAgents = agents.active || 0;
            const totalAgents = agents.total || 0;
            const archivedAgents = agents.archived || 0;
            const totalTasks = agents.total_tasks || 0;
            
            document.getElementById('active-agents').textContent = activeAgents;
            
            // Agent è¯¦ç»†ç»Ÿè®¡
            const agentTotalElement = document.getElementById('agent-total');
            const agentArchivedElement = document.getElementById('agent-archived');
            const agentTasksElement = document.getElementById('agent-tasks');
            
            if (agentTotalElement) agentTotalElement.textContent = totalAgents;
            if (agentArchivedElement) agentArchivedElement.textContent = archivedAgents;
            if (agentTasksElement) agentTasksElement.textContent = totalTasks;
            
            console.log('Updated Agent UI:', {activeAgents, totalAgents, archivedAgents, totalTasks}); // è°ƒè¯•æ—¥å¿—

            // å‘Šè­¦
            const alerts = data.alerts || {};
            document.getElementById('open-alerts').textContent = alerts.open || 0;
            
            // æ–°å¢ï¼šç³»ç»ŸçŠ¶æ€è¯¦æƒ…
            const lastEvent = health.last_event;
            if (lastEvent) {
                const eventTime = new Date(lastEvent.ts);
                const elapsed = Math.floor((Date.now() - eventTime.getTime()) / 1000);
                const heartbeatText = elapsed < 60 ? `${elapsed}ç§’å‰` : 
                                     elapsed < 3600 ? `${Math.floor(elapsed/60)}åˆ†é’Ÿå‰` : 
                                     `${Math.floor(elapsed/3600)}å°æ—¶å‰`;
                document.getElementById('system-heartbeat').textContent = heartbeatText;
            }
            
            // æ–°å¢ï¼šäº‹ä»¶è¯¦æƒ… - Top3ç±»å‹
            document.getElementById('events-errors').textContent = errorsCount;
            const eventStream = data.event_stream || [];
            const eventTypes = {};
            eventStream.forEach(e => {
                const type = e.type || e.event || 'unknown';
                eventTypes[type] = (eventTypes[type] || 0) + 1;
            });
            const top3 = Object.entries(eventTypes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([type, count]) => `${type} ${count}`)
                .join('<br>');
            document.getElementById('events-top3').innerHTML = top3 || 'æš‚æ— æ•°æ®';
            
            // æ–°å¢ï¼šAgentè¯¦æƒ… - æœ€å¿™Agent
            const agentList = agents.agents || [];
            const runningAgents = agentList.filter(a => a.status === 'active' && a.stats && a.stats.last_active);
            const waitingAgents = agentList.filter(a => a.status === 'active' && (!a.stats || !a.stats.last_active));
            document.getElementById('agent-status').textContent = `${runningAgents.length} / ${waitingAgents.length}`;
            
            if (runningAgents.length > 0) {
                const busiest = runningAgents.sort((a, b) => 
                    (b.stats.tasks_completed || 0) - (a.stats.tasks_completed || 0)
                )[0];
                const busiestText = `${busiest.name || busiest.id}<br>${busiest.stats.tasks_completed || 0} ä»»åŠ¡`;
                document.getElementById('agent-busiest').innerHTML = busiestText;
            } else {
                document.getElementById('agent-busiest').innerHTML = 'æš‚æ— ';
            }
            
            // æ–°å¢ï¼šå‘Šè­¦è¯¦æƒ…
            const recentAlerts = alerts.recent || [];
            const critAlerts = recentAlerts.filter(a => a.severity === 'CRIT').length;
            const warnAlerts = recentAlerts.filter(a => a.severity === 'WARN').length;
            document.getElementById('alert-levels').textContent = `${critAlerts} / ${warnAlerts}`;
            
            if (recentAlerts.length > 0) {
                const latest = recentAlerts[recentAlerts.length - 1];
                const latestText = `${latest.signature || latest.type}<br>${latest.first_seen || ''}`;
                document.getElementById('alert-latest').innerHTML = latestText;
            } else {
                document.getElementById('alert-latest').innerHTML = 'æ— ';
            }

            // æ¯æ—¥äº‹ä»¶é‡å›¾è¡¨ï¼ˆä½¿ç”¨ requestAnimationFrame é¿å…é˜»å¡ï¼‰
            if (data.daily_events && data.daily_events.length > 0) {
                const labels = data.daily_events.map(d => d.date);
                const counts = data.daily_events.map(d => d.count);
                
                eventsChart.data.labels = labels;
                eventsChart.data.datasets[0].data = counts;
                requestAnimationFrame(() => eventsChart.update('none'));
            }

            // è¿›åŒ–è¶‹åŠ¿å›¾è¡¨
            if (data.evolution_trend && data.evolution_trend.length > 0) {
                const labels = data.evolution_trend.map(d => d.time);
                const baseData = data.evolution_trend.map(d => d.base);
                const reactorData = data.evolution_trend.map(d => d.reactor);
                
                evolutionChart.data.labels = labels;
                evolutionChart.data.datasets[0].data = baseData;
                evolutionChart.data.datasets[1].data = reactorData;
                requestAnimationFrame(() => evolutionChart.update('none'));
            }

            // Reactor ç»Ÿè®¡
            const reactor = data.reactor_stats || {};
            
            console.log('Reactor stats:', reactor); // è°ƒè¯•æ—¥å¿—
            
            const autoExecRate = Math.round((reactor.auto_exec_rate || 0) * 100);
            const verifyRate = Math.round((reactor.verify_rate || 0) * 100);
            const totalPlaybooks = reactor.total_playbooks || 0;
            const breakersActive = reactor.breakers_active || 0;
            
            document.getElementById('reactor-exec').textContent = autoExecRate + '%';
            document.getElementById('reactor-verify').textContent = verifyRate + '%';
            document.getElementById('reactor-playbooks').textContent = totalPlaybooks;
            document.getElementById('reactor-breakers').textContent = breakersActive;
            
            console.log('Updated Reactor UI:', {autoExecRate, verifyRate, totalPlaybooks, breakersActive}); // è°ƒè¯•æ—¥å¿—

            // Scheduler ç»Ÿè®¡
            const scheduler = data.scheduler_stats || {};
            
            console.log('Scheduler stats:', scheduler); // è°ƒè¯•æ—¥å¿—
            
            const totalDecisions = scheduler.total_decisions || 0;
            const executedRate = Math.round((scheduler.executed_rate || 0) * 100);
            const avgLatency = Math.round(scheduler.avg_latency_ms || 0);
            const topAction = scheduler.top_action || '--';
            
            document.getElementById('scheduler-decisions').textContent = totalDecisions;
            document.getElementById('scheduler-executed').textContent = executedRate + '%';
            document.getElementById('scheduler-latency').textContent = avgLatency;
            document.getElementById('scheduler-top-action').textContent = topAction;
            
            console.log('Updated Scheduler UI:', {totalDecisions, executedRate, avgLatency, topAction}); // è°ƒè¯•æ—¥å¿—

            // Evolution å¡ç‰‡
            const evolution = data.evolution || {};
            const evolutionScore = evolution.score || 0;
            const evolutionScoreElement = document.getElementById('evolution-score');
            if (evolutionScoreElement) {
                evolutionScoreElement.textContent = evolutionScore.toFixed(2);
            }
            
            const grade = evolution.grade || 'unknown';
            const gradeText = grade === 'healthy' ? 'å¥åº·' : grade === 'degraded' ? 'é™çº§' : grade === 'critical' ? 'ä¸¥é‡' : 'æœªçŸ¥';
            const gradeElement = document.getElementById('evolution-grade');
            if (gradeElement) {
                gradeElement.textContent = gradeText;
            }
            
            const baseElement = document.getElementById('evolution-base');
            const reactorElement = document.getElementById('evolution-reactor');
            const autoElement = document.getElementById('evolution-auto');
            const verifyElement = document.getElementById('evolution-verify');
            
            if (baseElement) baseElement.textContent = (evolution.base || 0).toFixed(2);
            if (reactorElement) reactorElement.textContent = (evolution.reactor || 0).toFixed(2);
            if (autoElement) autoElement.textContent = Math.round((reactor.auto_exec_rate || 0) * 100) + '%';
            if (verifyElement) verifyElement.textContent = Math.round((reactor.verify_rate || 0) * 100) + '%';

            // Evolution å¡ç‰‡é¢œè‰²
            const evolutionCard = document.querySelector('.evolution-card');
            if (grade === 'healthy') {
                evolutionCard.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else if (grade === 'degraded') {
                evolutionCard.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else if (grade === 'critical') {
                evolutionCard.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }

            // Pipeline è¿è¡Œå†å²ï¼ˆæ‰©å±•åˆ°10æ¡ï¼‰
            const pipelineList = document.getElementById('pipeline-list');
            if (pipelineList && data.pipeline_runs && data.pipeline_runs.length > 0) {
                pipelineList.innerHTML = data.pipeline_runs.slice(0, 10).map(run => {
                    const statusIcon = run.status === 'success' ? 'âœ…' : run.status === 'failed' ? 'âŒ' : 'â¸ï¸';
                    const durationColor = run.duration_ms > 1000 ? '#ef4444' : run.duration_ms > 500 ? '#f59e0b' : '#10b981';
                    return `
                        <div class="pipeline-item">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${statusIcon}</span>
                                <span class="pipeline-time">${run.time}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 12px; color: #8b92a7;">${run.phase || 'unknown'}</span>
                                <span class="pipeline-duration">
                                    <span class="duration-dot" style="background: ${durationColor};"></span>
                                    ${run.duration_ms}ms
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else if (pipelineList) {
                pipelineList.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
            }

            // å‘Šè­¦åˆ—è¡¨
            const alertList = document.getElementById('alert-list');
            if (alerts.recent && alerts.recent.length > 0) {
                alertList.innerHTML = alerts.recent.slice(0, 5).map(alert => {
                    const stateText = alert.state === 'OPEN' ? 'å¾…å¤„ç†' : alert.state === 'ACK' ? 'å·²ç¡®è®¤' : 'å·²è§£å†³';
                    return `
                        <div class="alert-item">
                            <span class="alert-icon">âš ï¸</span>
                            <div class="alert-content">
                                <div class="alert-message">${alert.message || 'æœªçŸ¥å‘Šè­¦'}</div>
                                <div class="alert-time">${stateText} | ${alert.created_at || ''}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                alertList.innerHTML = '<div class="no-data">æš‚æ— å‘Šè­¦</div>';
            }

            // äº‹ä»¶æµ
            const eventStreamEl = document.getElementById('event-stream');
            if (data.event_stream && data.event_stream.length > 0) {
                allEvents = data.event_stream; // ä¿å­˜åˆ°å…¨å±€å˜é‡
                filterEvents(currentEventFilter); // åº”ç”¨å½“å‰ç­›é€‰
            }

            // ç³»ç»Ÿèµ„æºç›‘æ§
            if (data.system_resources) {
                const res = data.system_resources;
                
                // CPU
                const cpuElement = document.getElementById('cpu-usage');
                const cpuLoadElement = document.getElementById('cpu-load');
                if (cpuElement && res.cpu) {
                    cpuElement.textContent = Math.round(res.cpu.usage || 0) + '%';
                    cpuElement.style.color = res.cpu.usage > 80 ? '#ef4444' : res.cpu.usage > 60 ? '#f59e0b' : '#3b82f6';
                }
                if (cpuLoadElement && res.cpu) {
                    cpuLoadElement.textContent = (res.cpu.load || 0).toFixed(2);
                }
                
                // GPU
                const gpuElement = document.getElementById('gpu-usage');
                const gpuTempElement = document.getElementById('gpu-temp');
                if (gpuElement && res.gpu) {
                    gpuElement.textContent = Math.round(res.gpu.usage || 0) + '%';
                    gpuElement.style.color = res.gpu.usage > 80 ? '#ef4444' : res.gpu.usage > 60 ? '#f59e0b' : '#10b981';
                }
                if (gpuTempElement && res.gpu) {
                    gpuTempElement.textContent = res.gpu.temperature || '--';
                }
                
                // Memory
                const memoryElement = document.getElementById('memory-usage');
                const memoryUsedElement = document.getElementById('memory-used');
                const memoryTotalElement = document.getElementById('memory-total');
                if (memoryElement && res.memory) {
                    memoryElement.textContent = Math.round(res.memory.percent || 0) + '%';
                    memoryElement.style.color = res.memory.percent > 80 ? '#ef4444' : res.memory.percent > 60 ? '#f59e0b' : '#f59e0b';
                }
                if (memoryUsedElement && res.memory) {
                    memoryUsedElement.textContent = (res.memory.used_gb || 0).toFixed(1);
                }
                if (memoryTotalElement && res.memory) {
                    memoryTotalElement.textContent = (res.memory.total_gb || 0).toFixed(1);
                }
            }

            // å·¥å…·ä½¿ç”¨ç»Ÿè®¡
            if (data.tool_stats) {
                const toolStatsDiv = document.getElementById('tool-stats');
                if (toolStatsDiv) {
                    const stats = data.tool_stats;
                    const tools = Object.keys(stats).filter(k => stats[k].total > 0);
                    
                    if (tools.length > 0) {
                        toolStatsDiv.innerHTML = tools.map(tool => {
                            const s = stats[tool];
                            const successRate = s.total > 0 ? Math.round((s.success / s.total) * 100) : 0;
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #2a3555;">
                                    <span style="font-weight: 600;">${tool}</span>
                                    <div style="display: flex; gap: 15px; font-size: 14px;">
                                        <span style="color: #10b981;">âœ“ ${s.success}</span>
                                        <span style="color: #ef4444;">âœ— ${s.failed}</span>
                                        <span style="color: #8b92a7;">${s.avg_ms}ms</span>
                                        <span style="color: ${successRate >= 90 ? '#10b981' : successRate >= 70 ? '#f59e0b' : '#ef4444'};">${successRate}%</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        toolStatsDiv.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
                    }
                }
            }

            // ç£ç›˜ä½¿ç”¨æƒ…å†µ
            if (data.disk_usage) {
                const diskDiv = document.getElementById('disk-usage');
                if (diskDiv) {
                    const disks = data.disk_usage;
                    diskDiv.innerHTML = disks.map(disk => {
                        const percent = disk.percent || 0;
                        const color = percent > 90 ? '#ef4444' : percent > 70 ? '#f59e0b' : '#10b981';
                        return `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: 600;">${disk.mount}</span>
                                    <span style="color: ${color};">${percent.toFixed(1)}%</span>
                                </div>
                                <div style="background: #1e2847; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: ${color}; height: 100%; width: ${percent}%; transition: width 0.3s ease;"></div>
                                </div>
                                <div style="font-size: 12px; color: #8b92a7; margin-top: 5px;">
                                    ${disk.used_gb.toFixed(1)} GB / ${disk.total_gb.toFixed(1)} GB
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // ç½‘ç»œçŠ¶æ€
            if (data.network_status) {
                const netDiv = document.getElementById('network-status');
                if (netDiv) {
                    const net = data.network_status;
                    netDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #8b92a7; margin-bottom: 10px;">ä¸‹è½½é€Ÿåº¦</div>
                                <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${net.download_mbps.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #8b92a7; margin-top: 5px;">MB/s</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #8b92a7; margin-bottom: 10px;">ä¸Šä¼ é€Ÿåº¦</div>
                                <div style="font-size: 32px; font-weight: 700; color: #10b981;">${net.upload_mbps.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #8b92a7; margin-top: 5px;">MB/s</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #2a3555;">
                            <div style="display: flex; justify-content: space-between; font-size: 14px;">
                                <span style="color: #8b92a7;">æ€»ä¸‹è½½:</span>
                                <span style="color: #e0e6ed;">${net.total_download_gb.toFixed(2)} GB</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 8px;">
                                <span style="color: #8b92a7;">æ€»ä¸Šä¼ :</span>
                                <span style="color: #e0e6ed;">${net.total_upload_gb.toFixed(2)} GB</span>
                            </div>
                        </div>
                    `;
                }
            }

            // å¿ƒè·³ä»»åŠ¡çŠ¶æ€
            if (data.heartbeat_status && data.heartbeat_status.tasks) {
                const container = document.getElementById('heartbeat-tasks');
                if (container) {
                    container.innerHTML = data.heartbeat_status.tasks.map(task => {
                        const statusClass = task.status === 'overdue' ? 'overdue' : 
                                           task.status === 'never_run' ? 'never-run' : '';
                        
                        let statusText = '';
                        if (task.status === 'never_run') {
                            statusText = 'ä»æœªè¿è¡Œ';
                        } else if (task.status === 'overdue') {
                            statusText = `è¶…æ—¶ ${task.elapsed_minutes}åˆ†é’Ÿ`;
                        } else if (task.elapsed_minutes !== null) {
                            statusText = `${task.elapsed_minutes}åˆ†é’Ÿå‰`;
                        } else {
                            statusText = 'æœªçŸ¥';
                        }
                        
                        return `
                            <div class="heartbeat-task ${statusClass}">
                                <div class="heartbeat-task-name">${task.name}</div>
                                <div class="heartbeat-task-interval">${task.interval}</div>
                                <div class="heartbeat-task-status">
                                    <span class="heartbeat-status-dot ${statusClass}"></span>
                                    <span>${statusText}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }

        // WebSocket è¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('connection-status').textContent = 'ğŸŸ¢ åœ¨çº¿';
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('WebSocket message received:', message.type);
                    
                    if (message.type === 'snapshot' || message.type === 'update') {
                        updateDashboard(message.data);
                    } else {
                        console.warn('Unknown message type:', message.type);
                    }
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('connection-status').textContent = 'ğŸ”´ ç¦»çº¿';
                // 5ç§’åé‡è¿
                reconnectTimer = setTimeout(connectWebSocket, 5000);
            };
        }

        // äº‹ä»¶æµç­›é€‰
        let currentEventFilter = 'all';
        let allEvents = [];
        
        function filterEvents(type) {
            currentEventFilter = type;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('filter-all').style.background = type === 'all' ? '#3b82f6' : '#374151';
            document.getElementById('filter-error').style.background = type === 'error' ? '#ef4444' : '#374151';
            
            // åº”ç”¨ç­›é€‰
            const eventStream = document.getElementById('event-stream');
            let filtered = allEvents;
            
            if (type === 'error') {
                filtered = allEvents.filter(e => 
                    e.status === 'error' || 
                    (e.type && e.type.includes('error')) ||
                    (e.type && e.type.includes('failed'))
                );
            }
            
            if (filtered.length === 0) {
                eventStream.innerHTML = '<div class="no-data">æ— åŒ¹é…äº‹ä»¶</div>';
                return;
            }
            
            eventStream.innerHTML = filtered.slice(-20).reverse().map(event => {
                const timeStr = event.ts ? event.ts.split('T')[1].substring(0, 8) : 
                               event.timestamp ? new Date(event.timestamp).toLocaleTimeString('zh-CN', {hour12: false}) : '';
                
                const status = event.status || (event.type && event.type.includes('success') ? 'ok' : 
                               event.type && event.type.includes('error') ? 'err' : 'ok');
                const statusColor = status === 'ok' ? '#10b981' : '#ef4444';
                
                const latency = event.payload?.duration_ms || event.latency_ms || '-';
                const traceId = event.id || event.trace_id || '';
                const shortTraceId = traceId ? traceId.substring(0, 8) : '';
                
                return `
                    <div class="event-line" style="display: grid; grid-template-columns: 70px 80px 1fr 50px 50px 80px; gap: 8px; align-items: center;">
                        <span class="event-time" style="font-size: 11px;">${timeStr}</span>
                        <span class="event-layer" style="font-size: 10px; opacity: 0.7;">[${event.layer || 'UNKNOWN'}]</span>
                        <span class="event-type" style="font-size: 11px;">${event.type || event.event || 'unknown'}</span>
                        <span style="font-size: 10px; color: ${statusColor}; font-weight: 600;">${status}</span>
                        <span style="font-size: 10px; opacity: 0.7;">${latency}ms</span>
                        <span style="font-size: 9px; opacity: 0.5; font-family: monospace;" title="${traceId}">${shortTraceId}</span>
                    </div>
                `;
            }).join('');
        }

        // å¼ºåˆ¶åˆ·æ–°
        async function forceRefresh() {
            console.log('Force refresh triggered');
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = 'ğŸŸ¡ åˆ·æ–°ä¸­...';
            
            try {
                await pollSnapshot();
                statusElement.textContent = 'ğŸŸ¢ åœ¨çº¿';
            } catch (error) {
                console.error('Force refresh failed:', error);
                statusElement.textContent = 'ğŸ”´ åˆ·æ–°å¤±è´¥';
                setTimeout(() => {
                    statusElement.textContent = 'ğŸŸ¢ åœ¨çº¿';
                }, 2000);
            }
        }

        // HTTP è½®è¯¢é™çº§
        let _pollInFlight = false;
        async function pollSnapshot() {
            if (_pollInFlight) {
                console.log('Poll already in flight, skipping...');
                return;
            }
            _pollInFlight = true;
            try {
                console.log('Fetching snapshot...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                const response = await fetch('/api/snapshot', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Snapshot received:', Object.keys(data));
                updateDashboard(data);
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Polling error:', error);
                }
            } finally {
                _pollInFlight = false;
            }
        }

        // åˆå§‹åŒ–
        let initialized = false;
        window.addEventListener('load', async () => {
            if (initialized) {
                console.log('Already initialized, skipping...');
                return;
            }
            initialized = true;
            
            console.log('Initializing dashboard...');
            initCharts();
            
            // ç«‹å³æ‹‰å–ä¸€æ¬¡æ•°æ®ï¼ˆç¡®ä¿é¡µé¢åŠ è½½æ—¶æœ‰æ•°æ®ï¼‰
            await pollSnapshot();
            
            // ä¸å†è‡ªåŠ¨åˆ·æ–°ï¼Œåªä¿ç•™æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
            console.log('Auto-refresh disabled. Use manual refresh button.');
        });
    </script>
</body>
</html>
