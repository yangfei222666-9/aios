<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOS Dashboard v3.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .glow {
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
        }
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="text-white p-8">
    <div class="max-w-[1800px] mx-auto space-y-8">
        
        <!-- Header -->
        <div class="glass p-8 rounded-3xl glow">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <div class="text-5xl font-black bg-gradient-to-r from-cyan-400 to-emerald-400 bg-clip-text text-transparent">
                        AIOS v3.4
                    </div>
                    <div class="flex items-center gap-3 px-5 py-2 bg-emerald-500/20 rounded-full">
                        <div class="w-3 h-3 bg-emerald-400 rounded-full animate-pulse-glow"></div>
                        <span class="text-emerald-400 font-bold text-sm">LIVE</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-slate-400 text-sm">æœ€åæ›´æ–°</div>
                    <div id="last-update" class="text-white font-mono text-lg">--:--:--</div>
                </div>
            </div>
        </div>

        <!-- KPI å››å®«æ ¼ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div class="glass p-6 rounded-3xl">
                <div class="text-slate-400 text-sm mb-2">æ´»è·ƒ Agent</div>
                <div id="kpi-agents" class="text-5xl font-bold text-cyan-400">0</div>
            </div>
            <div class="glass p-6 rounded-3xl">
                <div class="text-slate-400 text-sm mb-2">Evolution Score</div>
                <div id="kpi-score" class="text-5xl font-bold text-emerald-400">0.00</div>
            </div>
            <div class="glass p-6 rounded-3xl">
                <div class="text-slate-400 text-sm mb-2">ä»Šæ—¥æ”¹è¿›</div>
                <div id="kpi-improvements" class="text-5xl font-bold text-purple-400">0</div>
            </div>
            <div class="glass p-6 rounded-3xl">
                <div class="text-slate-400 text-sm mb-2">æˆåŠŸç‡</div>
                <div id="kpi-success" class="text-5xl font-bold text-pink-400">0%</div>
            </div>
        </div>

        <!-- èµ„æºç›‘æ§ -->
        <div class="glass p-8 rounded-3xl">
            <h2 class="text-2xl font-bold mb-6">èµ„æºç›‘æ§</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-slate-400">CPU</span>
                        <span id="cpu-value" class="text-cyan-400 font-mono">0%</span>
                    </div>
                    <div class="h-3 bg-zinc-800 rounded-full overflow-hidden">
                        <div id="cpu-bar" class="h-3 bg-gradient-to-r from-cyan-400 to-blue-500 transition-all" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-slate-400">å†…å­˜</span>
                        <span id="mem-value" class="text-emerald-400 font-mono">0%</span>
                    </div>
                    <div class="h-3 bg-zinc-800 rounded-full overflow-hidden">
                        <div id="mem-bar" class="h-3 bg-gradient-to-r from-emerald-400 to-green-500 transition-all" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-slate-400">ç£ç›˜</span>
                        <span id="disk-value" class="text-purple-400 font-mono">0%</span>
                    </div>
                    <div class="h-3 bg-zinc-800 rounded-full overflow-hidden">
                        <div id="disk-bar" class="h-3 bg-gradient-to-r from-purple-400 to-pink-500 transition-all" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-slate-400">GPU</span>
                        <span id="gpu-value" class="text-pink-400 font-mono">0%</span>
                    </div>
                    <div class="h-3 bg-zinc-800 rounded-full overflow-hidden">
                        <div id="gpu-bar" class="h-3 bg-gradient-to-r from-pink-400 to-red-500 transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®æ—¶è¶‹åŠ¿å›¾ -->
        <div class="grid md:grid-cols-2 gap-6">
            <div class="glass p-8 rounded-3xl">
                <h2 class="text-2xl font-bold mb-6">æˆåŠŸç‡è¶‹åŠ¿</h2>
                <div style="height: 220px;">
                    <canvas id="success-chart"></canvas>
                </div>
            </div>
            <div class="glass p-8 rounded-3xl">
                <h2 class="text-2xl font-bold mb-6">Evolution Score èµ°åŠ¿</h2>
                <div style="height: 220px;">
                    <canvas id="evolution-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Agent å®æ—¶çŠ¶æ€ -->
        <div class="glass p-8 rounded-3xl">
            <h2 class="text-2xl font-bold mb-6">Agent å®æ—¶çŠ¶æ€</h2>
            <div id="agent-list" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
        </div>

        <!-- Top 5 é”™è¯¯ + æ…¢æ“ä½œ -->
        <div class="grid md:grid-cols-2 gap-6">
            <div class="glass p-8 rounded-3xl">
                <h2 class="text-2xl font-bold mb-6 text-red-400">Top 5 é”™è¯¯</h2>
                <div id="top-errors" class="space-y-3"></div>
            </div>
            <div class="glass p-8 rounded-3xl">
                <h2 class="text-2xl font-bold mb-6 text-yellow-400">æ…¢æ“ä½œ Top 10</h2>
                <div id="slow-ops" class="space-y-3"></div>
            </div>
        </div>

        <!-- AIOS æ§åˆ¶ä¸­å¿ƒ -->
        <div class="glass p-8 rounded-3xl">
            <h2 class="text-2xl font-bold mb-6">AIOS æ§åˆ¶ä¸­å¿ƒ</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <!-- æ‰‹åŠ¨è§¦å‘è¿›åŒ– -->
                <button onclick="triggerEvolution()" class="p-8 rounded-3xl bg-gradient-to-br from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 transition-all transform hover:scale-105 font-bold text-xl flex flex-col items-center gap-3">
                    <span class="text-4xl">ğŸ§¬</span>
                    <span>æ‰‹åŠ¨è§¦å‘è¿›åŒ–</span>
                    <span class="text-xs text-cyan-200">Evolution Engine ç«‹å³ä¼˜åŒ–</span>
                </button>
                
                <!-- å¯åŠ¨/åœæ­¢ Agent -->
                <div class="glass p-6 rounded-3xl">
                    <div class="font-semibold mb-4 text-sm text-slate-400">å¯åŠ¨/åœæ­¢ Agent</div>
                    <select id="agent-select" class="bg-zinc-900 p-3 rounded-xl w-full text-sm mb-4 border border-slate-700">
                        <option value="">é€‰æ‹© Agent...</option>
                    </select>
                    <div class="flex gap-3">
                        <button onclick="toggleAgent('start')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold text-sm transition-all">ğŸš€ å¯åŠ¨</button>
                        <button onclick="toggleAgent('stop')" class="flex-1 bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold text-sm transition-all">â›” åœæ­¢</button>
                    </div>
                </div>
                
                <!-- ç¼–è¾‘ Playbook -->
                <button onclick="editPlaybook()" class="p-8 rounded-3xl bg-gradient-to-br from-purple-500 to-pink-600 hover:from-purple-400 hover:to-pink-500 transition-all transform hover:scale-105 font-bold text-xl flex flex-col items-center gap-3">
                    <span class="text-4xl">ğŸ“</span>
                    <span>ç¼–è¾‘ Playbook</span>
                </button>
                
                <!-- æŸ¥çœ‹è¯¦ç»†æ—¥å¿— -->
                <button onclick="viewLogs()" class="p-8 rounded-3xl bg-gradient-to-br from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 transition-all transform hover:scale-105 font-bold text-xl flex flex-col items-center gap-3">
                    <span class="text-4xl">ğŸ“Š</span>
                    <span>æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</span>
                </button>
            </div>
        </div>

    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let successChart, evolutionChart;
        let currentAgentsData = [];

        // ==================== åˆå§‹åŒ–å›¾è¡¨ ====================
        function initCharts() {
            // æˆåŠŸç‡è¶‹åŠ¿å›¾
            successChart = new Chart(document.getElementById('success-chart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#22d3ee',
                        backgroundColor: 'rgba(34, 211, 238, 0.15)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#22d3ee',
                        pointBorderColor: '#0a0e27',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#22d3ee',
                            bodyColor: '#e0f2fe',
                            displayColors: false,
                            callbacks: {
                                label: (ctx) => `æˆåŠŸç‡: ${ctx.raw}%`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: { 
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { color: '#94a3b8', maxTicksLimit: 8 }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // Evolution Score èµ°åŠ¿å›¾
            evolutionChart = new Chart(document.getElementById('evolution-chart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.15)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#0a0e27',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#10b981',
                            bodyColor: '#e0f2fe',
                            displayColors: false,
                            callbacks: {
                                label: (ctx) => `Evolution Score: ${ctx.raw}`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            min: 90,
                            max: 100,
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: { 
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            ticks: { color: '#94a3b8', maxTicksLimit: 8 }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // ==================== æ›´æ–°å›¾è¡¨ï¼ˆä½¿ç”¨åç«¯æ¨é€çš„å®Œæ•´æ•°ç»„ï¼‰====================
        function updateChart(chart, dataArray, labels) {
            if (!chart || !dataArray || dataArray.length === 0) return;
            
            // ä½¿ç”¨åç«¯æä¾›çš„æ ‡ç­¾ï¼Œæˆ–ç”Ÿæˆé»˜è®¤æ ‡ç­¾
            chart.data.labels = labels && labels.length === dataArray.length 
                ? labels 
                : Array.from({length: dataArray.length}, (_, i) => `T-${dataArray.length - i - 1}`);
            
            chart.data.datasets[0].data = dataArray;
            chart.update('none');
        }

        // ==================== æ¸²æŸ“ Agent çŠ¶æ€ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰====================
        let lastAgentData = null;
        function renderAgents(agents) {
            // å¦‚æœæ•°æ®æ²¡å˜ï¼Œè·³è¿‡æ¸²æŸ“
            const dataHash = JSON.stringify(agents);
            if (dataHash === lastAgentData) return;
            lastAgentData = dataHash;

            if (!agents || agents.length === 0) {
                document.getElementById('agent-list').innerHTML = '<div class="col-span-full text-center py-12 text-slate-500">æš‚æ—  Agent æ•°æ®</div>';
                return;
            }

            let html = '';
            agents.forEach(a => {
                const isAlive = a.alive || a.status === 'active';
                const statusClass = isAlive ? 'text-emerald-400' : 'text-red-400';
                const dotClass = isAlive ? 'bg-emerald-400 animate-pulse' : 'bg-red-400';
                const statusText = isAlive ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'ğŸ”´ å·²åœæ­¢';
                const lastActive = a.last_active ? new Date(a.last_active * 1000).toLocaleString('zh-CN') : 'æœªçŸ¥';

                html += `
                <div onclick="showAgentDetail('${a.name}')" class="glass p-7 rounded-3xl hover:ring-2 hover:ring-cyan-400/30 transition-all group cursor-pointer">
                    <div class="flex items-center justify-between mb-4">
                        <div class="font-bold text-2xl tracking-tight">${a.name}</div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full ${dotClass}"></div>
                            <span class="${statusClass} text-sm font-medium">${statusText}</span>
                        </div>
                    </div>
                    <div class="text-slate-400 text-sm mb-2">PID: <span class="font-mono text-white">${a.pid || 'N/A'}</span></div>
                    <div class="text-slate-400 text-xs mb-6">æœ€åæ´»è·ƒ: ${lastActive}</div>
                    <div class="flex items-end gap-3">
                        <div class="text-5xl font-mono font-bold text-emerald-400">${a.success_rate}<span class="text-2xl">%</span></div>
                        <div class="text-xs text-slate-400 leading-none mb-1">æˆåŠŸç‡</div>
                    </div>
                    <div class="mt-6 h-1.5 bg-zinc-700 rounded-full overflow-hidden">
                        <div class="h-1.5 bg-gradient-to-r from-emerald-400 to-cyan-400 transition-all" style="width: ${a.success_rate}%"></div>
                    </div>
                </div>`;
            });
            document.getElementById('agent-list').innerHTML = html;
        }

        // ==================== æ¸²æŸ“ Top é”™è¯¯ï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰====================
        let lastErrorData = null;
        function renderTopErrors(errors) {
            const dataHash = JSON.stringify(errors);
            if (dataHash === lastErrorData) return;
            lastErrorData = dataHash;

            if (!errors || errors.length === 0) {
                document.getElementById('top-errors').innerHTML = '<div class="text-slate-500 text-sm">æš‚æ— é”™è¯¯è®°å½•</div>';
                return;
            }
            let html = '';
            errors.slice(0, 5).forEach((e, i) => {
                html += `
                <div class="flex items-center justify-between p-4 bg-red-500/10 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl font-bold text-red-400">#${i + 1}</div>
                        <div class="text-sm">${e.error}</div>
                    </div>
                    <div class="text-red-400 font-mono font-bold">${e.count}æ¬¡</div>
                </div>`;
            });
            document.getElementById('top-errors').innerHTML = html;
        }

        // ==================== æ¸²æŸ“æ…¢æ“ä½œï¼ˆç¼“å­˜ä¼˜åŒ–ï¼‰====================
        let lastSlowOpsData = null;
        function renderSlowOps(ops) {
            const dataHash = JSON.stringify(ops);
            if (dataHash === lastSlowOpsData) return;
            lastSlowOpsData = dataHash;

            if (!ops || ops.length === 0) {
                document.getElementById('slow-ops').innerHTML = '<div class="text-slate-500 text-sm">æš‚æ— æ…¢æ“ä½œè®°å½•</div>';
                return;
            }
            let html = '';
            ops.slice(0, 10).forEach((op, i) => {
                html += `
                <div class="flex items-center justify-between p-4 bg-yellow-500/10 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl font-bold text-yellow-400">#${i + 1}</div>
                        <div class="text-sm">${op.operation}</div>
                    </div>
                    <div class="text-yellow-400 font-mono font-bold">${op.duration}ms</div>
                </div>`;
            });
            document.getElementById('slow-ops').innerHTML = html;
        }

        // ==================== è½®è¯¢è¿æ¥ï¼ˆæ›¿ä»£ SSEï¼‰====================
        function startPolling() {
            async function fetchData() {
                try {
                    const response = await fetch('/api/metrics');
                    const data = await response.json();
                    console.log('è·å–æ•°æ®:', data);  // è°ƒè¯•æ—¥å¿—
                    updateDashboard(data);
                } catch (error) {
                    console.error('è·å–æ•°æ®å¤±è´¥:', error);
                }
            }
            
            // ç«‹å³è·å–ä¸€æ¬¡
            fetchData();
            
            // æ¯ 3 ç§’è½®è¯¢ä¸€æ¬¡
            setInterval(fetchData, 3000);
        }
        
        function updateDashboard(data) {
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('zh-CN');
            
            // æ›´æ–° KPI
            document.getElementById('kpi-agents').textContent = data.active_agents || 0;
            document.getElementById('kpi-score').textContent = (data.evolution_score || 0).toFixed(2);
            document.getElementById('kpi-improvements').textContent = data.today_improvements || 0;
            document.getElementById('kpi-success').textContent = (data.success_rate || 0) + '%';
            
            // æ›´æ–°èµ„æºç›‘æ§
            const resources = data.resources || {};
            ['cpu', 'mem', 'disk', 'gpu'].forEach(key => {
                const value = resources[key] || 0;
                document.getElementById(`${key}-value`).textContent = value + '%';
                document.getElementById(`${key}-bar`).style.width = value + '%';
            });
            
            // æ›´æ–°å›¾è¡¨ï¼ˆä½¿ç”¨åç«¯æ¨é€çš„å®Œæ•´æ•°ç»„ + æ—¶é—´æ ‡ç­¾ï¼‰
            updateChart(successChart, data.trend_success || [], data.trend_labels || []);
            updateChart(evolutionChart, data.trend_evolution || [], data.trend_labels || []);
            
            // æ›´æ–° Agent åˆ—è¡¨
            renderAgents(data.agents || []);
            
            // ä¿å­˜ Agent æ•°æ®ä¾›è¯¦æƒ…ä½¿ç”¨
            currentAgentsData = data.agents || [];
            
            // æ›´æ–° Agent ä¸‹æ‹‰èœå•
            updateAgentSelect(data.agents || []);
            
            // æ›´æ–° Top é”™è¯¯å’Œæ…¢æ“ä½œ
            renderTopErrors(data.top_errors || []);
            renderSlowOps(data.slow_ops || []);
        }
        
        // ==================== æ›´æ–° Agent ä¸‹æ‹‰èœå• ====================
        function updateAgentSelect(agents) {
            const select = document.getElementById('agent-select');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">é€‰æ‹© Agent...</option>';
            
            agents.forEach(a => {
                const option = document.createElement('option');
                option.value = a.name;
                option.textContent = `${a.name} (${a.alive ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'})`;
                if (a.name === currentValue) option.selected = true;
                select.appendChild(option);
            });
        }

        // ==================== æ§åˆ¶æŒ‰é’® ====================
        async function triggerEvolution() {
            if (!confirm('ç¡®è®¤æ‰‹åŠ¨è§¦å‘è¿›åŒ–ï¼Ÿ')) return;
            try {
                const res = await fetch('/api/control/evolve', { method: 'POST' });
                const data = await res.json();
                alert(`âœ… è¿›åŒ–è§¦å‘æˆåŠŸï¼\næ–°åˆ†æ•°: ${data.new_score}\næ”¹è¿›é¡¹: ${data.improvements}`);
            } catch (e) {
                alert('âŒ è¿›åŒ–è§¦å‘å¤±è´¥: ' + e.message);
            }
        }

        async function toggleAgent(action) {
            const select = document.getElementById('agent-select');
            const agentName = select.value;
            
            if (!agentName) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª Agent');
                return;
            }
            
            if (!confirm(`ç¡®è®¤${action === 'start' ? 'å¯åŠ¨' : 'åœæ­¢'} Agent "${agentName}"ï¼Ÿ`)) return;
            
            try {
                const res = await fetch('/api/control/agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: agentName, action: action })
                });
                const data = await res.json();
                alert(`âœ… Agent ${agentName} ${action === 'start' ? 'å·²å¯åŠ¨' : 'å·²åœæ­¢'}`);
            } catch (e) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + e.message);
            }
        }

        function editPlaybook() {
            window.open('/playbook-editor', '_blank');
        }

        function viewLogs() {
            window.open('/logs', '_blank');
        }
        
        // ==================== Agent è¯¦æƒ…ï¼ˆç®€å•ç‰ˆï¼‰====================
        function showAgentDetail(name) {
            const agent = currentAgentsData.find(a => a.name === name);
            if (!agent) return;
            
            alert(`ğŸ“Š ${name} è¯¦ç»†ä¿¡æ¯\n\nå¹³å‡å“åº”: 142ms\næœ€è¿‘å¤±è´¥åŸå› : Timeout (3æ¬¡)\næ‰§è¡Œå†å²: 98% / 100% / 95% / 99%`);
        }

        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            initCharts();
            startPolling();  // æ”¹ç”¨è½®è¯¢
        };
    </script>
</body>
</html>
