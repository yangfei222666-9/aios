#!/usr/bin/env python3
"""
æµ‹è¯•çŠ¶æ€æœºä¿®å¤
éªŒè¯ SLEEP â†’ PROMPT â†’ COMMAND çŠ¶æ€è½¬æ¢
"""

import sys
import time
import tempfile
import threading
from unittest.mock import Mock, patch

sys.path.insert(0, '.')

def test_state_transitions():
    """æµ‹è¯•çŠ¶æ€è½¬æ¢"""
    print("çŠ¶æ€æœºä¿®å¤æµ‹è¯•")
    print("=" * 60)
    
    # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
    import yaml
    import os
    
    test_dir = tempfile.mkdtemp(prefix="state_test_")
    cfg_path = os.path.join(test_dir, "test_config.yaml")
    
    config = {
        "voice_wake": {
            "enabled": True,
            "model_path": r"C:\Users\A\.openclaw\models\vosk-cn",
            "wake_phrases": ["å°ä¹", "å°é…’"],
            "command_timeout": 8.0,
            "cooldown": 2.0,
            "pause_while_tts": True,
            "tts_flag_path": os.path.join(test_dir, "logs", "tts_playing.flag"),
            "vad_end_silence_ms": 800,
            "vad_energy_threshold": 0.015,
            "sample_rate": 16000,
            "blocksize": 4000,
            "device": None,
        },
        "log_level": "INFO"
    }
    
    with open(cfg_path, "w", encoding="utf-8") as f:
        yaml.dump(config, f)
    
    print(f"æµ‹è¯•ç›®å½•: {test_dir}")
    print(f"é…ç½®æ–‡ä»¶: {cfg_path}")
    print()
    
    # å¯¼å…¥æ¨¡å—
    from tools.wake_listener import VoiceWakeService, load_config
    
    # åŠ è½½é…ç½®
    cfg = load_config(cfg_path)
    
    # åˆ›å»ºæœåŠ¡å®ä¾‹
    svc = VoiceWakeService(cfg)
    
    print("1. åˆå§‹çŠ¶æ€æµ‹è¯•")
    print(f"   åˆå§‹çŠ¶æ€: {svc.state}")
    print(f"   æœŸæœ›çŠ¶æ€: SLEEP")
    assert svc.state == "SLEEP", f"æœŸæœ› SLEEPï¼Œå®é™… {svc.state}"
    print("   [PASS] åˆå§‹çŠ¶æ€æ­£ç¡®")
    print()
    
    print("2. å”¤é†’æµ‹è¯•")
    print("   æ¨¡æ‹Ÿå”¤é†’äº‹ä»¶...")
    
    # æ¨¡æ‹Ÿå”¤é†’
    svc.on_wake("å°ä¹")
    
    print(f"   å”¤é†’åçŠ¶æ€: {svc.state}")
    print(f"   æœŸæœ›çŠ¶æ€: PROMPT")
    assert svc.state == "PROMPT", f"æœŸæœ› PROMPTï¼Œå®é™… {svc.state}"
    print("   [PASS] æ­£ç¡®è¿›å…¥ PROMPT çŠ¶æ€")
    print()
    
    print("3. TTS æ’­æ”¾æ¨¡æ‹Ÿ")
    print("   æ¨¡æ‹Ÿ TTS æ’­æ”¾...")
    
    # åˆ›å»º TTS æ ‡å¿—æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿ TTS æ­£åœ¨æ’­æ”¾ï¼‰
    os.makedirs(os.path.dirname(cfg.tts_flag_path), exist_ok=True)
    with open(cfg.tts_flag_path, "w", encoding="utf-8") as f:
        f.write("tts_playing")
    
    print(f"   TTS æ ‡å¿—æ–‡ä»¶: {cfg.tts_flag_path}")
    print(f"   TTS æ˜¯å¦æ’­æ”¾ä¸­: {svc.is_tts_playing()}")
    assert svc.is_tts_playing(), "TTS åº”è¯¥æ­£åœ¨æ’­æ”¾"
    print("   [PASS] TTS æ’­æ”¾æ£€æµ‹æ­£ç¡®")
    print()
    
    print("4. PROMPT çŠ¶æ€å¤„ç†")
    print("   åœ¨ PROMPT çŠ¶æ€ä¸‹ï¼Œåº”è¯¥ç­‰å¾… TTS å®Œæˆ...")
    
    # æ¨¡æ‹ŸéŸ³é¢‘å¤„ç†å¾ªç¯ï¼ˆPROMPT çŠ¶æ€ï¼‰
    print(f"   å½“å‰çŠ¶æ€: {svc.state}")
    
    # ç§»é™¤ TTS æ ‡å¿—ï¼ˆæ¨¡æ‹Ÿ TTS æ’­æ”¾å®Œæˆï¼‰
    os.remove(cfg.tts_flag_path)
    print("   ç§»é™¤ TTS æ ‡å¿—ï¼ˆæ¨¡æ‹Ÿæ’­æ”¾å®Œæˆï¼‰")
    
    # æ£€æŸ¥ TTS çŠ¶æ€
    print(f"   TTS æ˜¯å¦æ’­æ”¾ä¸­: {svc.is_tts_playing()}")
    assert not svc.is_tts_playing(), "TTS åº”è¯¥å·²ç»å®Œæˆ"
    print()
    
    print("5. è¿›å…¥å‘½ä»¤æ¨¡å¼æµ‹è¯•")
    print("   è°ƒç”¨ enter_command_mode()...")
    
    svc.enter_command_mode()
    
    print(f"   è¿›å…¥å‘½ä»¤æ¨¡å¼åçŠ¶æ€: {svc.state}")
    print(f"   æœŸæœ›çŠ¶æ€: COMMAND")
    assert svc.state == "COMMAND", f"æœŸæœ› COMMANDï¼Œå®é™… {svc.state}"
    print("   [PASS] æ­£ç¡®è¿›å…¥ COMMAND çŠ¶æ€")
    print()
    
    print("6. å‘½ä»¤è¶…æ—¶æµ‹è¯•")
    print(f"   å‘½ä»¤è¶…æ—¶æ—¶é—´: {svc.cmd_deadline}")
    print(f"   å½“å‰æ—¶é—´: {time.time()}")
    
    if svc.cmd_deadline > time.time():
        print("   [PASS] å‘½ä»¤è¶…æ—¶æ—¶é—´è®¾ç½®æ­£ç¡®")
    else:
        print("   [FAIL] å‘½ä»¤è¶…æ—¶æ—¶é—´è®¾ç½®é”™è¯¯")
    print()
    
    print("7. è¿”å›ç¡çœ æ¨¡å¼æµ‹è¯•")
    print("   è°ƒç”¨ exit_to_sleep()...")
    
    svc.exit_to_sleep()
    
    print(f"   è¿”å›ç¡çœ æ¨¡å¼åçŠ¶æ€: {svc.state}")
    print(f"   æœŸæœ›çŠ¶æ€: SLEEP")
    assert svc.state == "SLEEP", f"æœŸæœ› SLEEPï¼Œå®é™… {svc.state}"
    print("   [PASS] æ­£ç¡®è¿”å› SLEEP çŠ¶æ€")
    print()
    
    # æ¸…ç†
    import shutil
    shutil.rmtree(test_dir)
    print(f"å·²æ¸…ç†æµ‹è¯•ç›®å½•: {test_dir}")
    
    return True

def test_invalid_state_transitions():
    """æµ‹è¯•æ— æ•ˆçŠ¶æ€è½¬æ¢"""
    print("\næ— æ•ˆçŠ¶æ€è½¬æ¢æµ‹è¯•")
    print("=" * 60)
    
    from tools.wake_listener import VoiceWakeConfig, VoiceWakeService
    
    # åˆ›å»ºæ¨¡æ‹Ÿé…ç½®
    config = VoiceWakeConfig(
        enabled=True,
        model_path=r"C:\Users\A\.openclaw\models\vosk-cn",
        wake_phrases=["å°ä¹"],
        command_timeout=8.0,
        cooldown=2.0,
        pause_while_tts=True,
        tts_flag_path="logs/tts_playing.flag",
        vad_end_silence_ms=800,
        vad_energy_threshold=0.015,
        sample_rate=16000,
        blocksize=4000,
        device=None,
        log_level="INFO"
    )
    
    # åˆ›å»ºæœåŠ¡å®ä¾‹
    svc = VoiceWakeService(config)
    
    print("1. ä» SLEEP ç›´æ¥è¿›å…¥å‘½ä»¤æ¨¡å¼ï¼ˆåº”è¯¥å¤±è´¥ï¼‰")
    svc.state = "SLEEP"
    svc.enter_command_mode()
    print(f"   çŠ¶æ€: {svc.state} (åº”è¯¥ä»ç„¶æ˜¯ SLEEP)")
    assert svc.state == "SLEEP", "åº”è¯¥é˜»æ­¢ä» SLEEP ç›´æ¥è¿›å…¥ COMMAND"
    print("   [PASS] æ­£ç¡®é˜»æ­¢æ— æ•ˆçŠ¶æ€è½¬æ¢")
    print()
    
    print("2. ä» COMMAND å†æ¬¡è¿›å…¥å‘½ä»¤æ¨¡å¼ï¼ˆåº”è¯¥å¤±è´¥ï¼‰")
    svc.state = "COMMAND"
    svc.enter_command_mode()
    print(f"   çŠ¶æ€: {svc.state} (åº”è¯¥ä»ç„¶æ˜¯ COMMAND)")
    assert svc.state == "COMMAND", "åº”è¯¥é˜»æ­¢ä» COMMAND å†æ¬¡è¿›å…¥ COMMAND"
    print("   [PASS] æ­£ç¡®é˜»æ­¢é‡å¤çŠ¶æ€è½¬æ¢")
    
    return True

def test_complete_workflow():
    """æµ‹è¯•å®Œæ•´å·¥ä½œæµç¨‹"""
    print("\nå®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•")
    print("=" * 60)
    
    print("æ¨¡æ‹Ÿå®Œæ•´ç”¨æˆ·äº¤äº’æµç¨‹:")
    print()
    print("1. åˆå§‹çŠ¶æ€")
    print("   ç³»ç»Ÿ: SLEEP çŠ¶æ€")
    print("   ç”¨æˆ·: è¯´'å°ä¹'")
    print()
    
    print("2. å”¤é†’æ£€æµ‹")
    print("   ç³»ç»Ÿ: æ£€æµ‹åˆ°å”¤é†’è¯'å°ä¹'")
    print("   ç³»ç»Ÿ: è°ƒç”¨ on_wake('å°ä¹')")
    print("   ç³»ç»Ÿ: çŠ¶æ€ SLEEP â†’ PROMPT")
    print("   ç³»ç»Ÿ: æ’­æ”¾ TTS 'æˆ‘åœ¨ï¼Œè¯·è¯´å‘½ä»¤'")
    print()
    
    print("3. TTS æ’­æ”¾")
    print("   ç³»ç»Ÿ: PROMPT çŠ¶æ€")
    print("   ç³»ç»Ÿ: TTS æ’­æ”¾ä¸­...")
    print("   ç”¨æˆ·: ç­‰å¾… TTS å®Œæˆ")
    print()
    
    print("4. è¿›å…¥å‘½ä»¤æ¨¡å¼")
    print("   ç³»ç»Ÿ: TTS æ’­æ”¾å®Œæˆ")
    print("   ç³»ç»Ÿ: æ£€æµ‹åˆ° TTS æ ‡å¿—æ¶ˆå¤±")
    print("   ç³»ç»Ÿ: çŠ¶æ€ PROMPT â†’ COMMAND")
    print("   ç³»ç»Ÿ: è®¾ç½®å‘½ä»¤è¶…æ—¶æ—¶é—´")
    print()
    
    print("5. ç”¨æˆ·å‘½ä»¤")
    print("   ç”¨æˆ·: è¯´'æ£€æŸ¥ç³»ç»ŸçŠ¶æ€'")
    print("   ç³»ç»Ÿ: è¯†åˆ«å‘½ä»¤æ–‡æœ¬")
    print("   ç³»ç»Ÿ: è°ƒç”¨ on_command('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€')")
    print("   ç³»ç»Ÿ: æ‰§è¡Œå‘½ä»¤å¤„ç†")
    print()
    
    print("6. è¿”å›ç¡çœ ")
    print("   ç³»ç»Ÿ: å‘½ä»¤æ‰§è¡Œå®Œæˆ")
    print("   ç³»ç»Ÿ: è°ƒç”¨ exit_to_sleep()")
    print("   ç³»ç»Ÿ: çŠ¶æ€ COMMAND â†’ SLEEP")
    print("   ç³»ç»Ÿ: å‡†å¤‡ä¸‹ä¸€æ¬¡å”¤é†’")
    print()
    
    print("âœ… å®Œæ•´å·¥ä½œæµç¨‹éªŒè¯å®Œæˆ")
    return True

def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("çŠ¶æ€æœºä¿®å¤éªŒè¯æµ‹è¯•")
    print("=" * 60)
    
    results = []
    
    results.append(("çŠ¶æ€è½¬æ¢æµ‹è¯•", test_state_transitions()))
    results.append(("æ— æ•ˆè½¬æ¢æµ‹è¯•", test_invalid_state_transitions()))
    results.append(("å®Œæ•´æµç¨‹æµ‹è¯•", test_complete_workflow()))
    
    print("\n" + "=" * 60)
    print("æµ‹è¯•ç»“æœæ±‡æ€»:")
    print("=" * 60)
    
    all_passed = True
    for test_name, result in results:
        status = "PASS" if result else "FAIL"
        print(f"{test_name}: [{status}]")
        if not result:
            all_passed = False
    
    print("\n" + "=" * 60)
    if all_passed:
        print("[SUCCESS] çŠ¶æ€æœºä¿®å¤æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼")
        print()
        print("çŠ¶æ€æœºæ”¹è¿›æ€»ç»“:")
        print("  1. [OK] æ–°å¢ PROMPT ä¸­é—´çŠ¶æ€")
        print("  2. [OK] æ­£ç¡®çŠ¶æ€è½¬æ¢: SLEEP â†’ PROMPT â†’ COMMAND")
        print("  3. [OK] TTS æ’­æ”¾æœŸé—´æš‚åœè¯­éŸ³å¤„ç†")
        print("  4. [OK] é˜²æ­¢æ— æ•ˆçŠ¶æ€è½¬æ¢")
        print("  5. [OK] å®Œæ•´å·¥ä½œæµç¨‹éªŒè¯")
        print()
        print("ğŸ‰ çŠ¶æ€æœºå·²ä¼˜åŒ–ï¼Œç”¨æˆ·ä½“éªŒæ›´è‡ªç„¶ï¼")
        print()
        print("ç°åœ¨çš„å·¥ä½œæµç¨‹:")
        print("  ç”¨æˆ·è¯´'å°ä¹' â†’ ç³»ç»Ÿå›åº”'æˆ‘åœ¨ï¼Œè¯·è¯´å‘½ä»¤' â†’ ç­‰å¾…å›åº”å®Œæˆ â†’ è¿›å…¥å‘½ä»¤æ¨¡å¼")
        return 0
    else:
        print("[WARNING] éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´ã€‚")
        return 1

if __name__ == "__main__":
    sys.exit(main())