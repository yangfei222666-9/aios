#!/usr/bin/env python3
"""
æ£€æŸ¥æ–‡ä»¶ç¼–ç è§„èŒƒ
ç¡®ä¿æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½ä½¿ç”¨æ­£ç¡®çš„ç¼–ç è®¾ç½®
"""

import os
import re
import sys
from pathlib import Path

# ç¼–ç ä¿®å¤
if sys.platform == "win32":
    try:
        sys.stdout.reconfigure(encoding="utf-8", errors="replace")
        sys.stderr.reconfigure(encoding="utf-8", errors="replace")
    except AttributeError:
        import io
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
        sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

def check_file_operations():
    """æ£€æŸ¥æ–‡ä»¶æ“ä½œç¼–ç è§„èŒƒ"""
    print("æ–‡ä»¶ç¼–ç è§„èŒƒæ£€æŸ¥")
    print("=" * 60)
    
    # æ£€æŸ¥ç›®å½•
    directories = ["tools", "."]
    
    issues = []
    good_practices = []
    
    for directory in directories:
        if not os.path.exists(directory):
            continue
            
        for py_file in Path(directory).rglob("*.py"):
            try:
                with open(py_file, "r", encoding="utf-8") as f:
                    content = f.read()
                
                # æŸ¥æ‰¾æ‰€æœ‰ open() è°ƒç”¨
                open_pattern = r'open\([^)]+\)'
                matches = re.finditer(open_pattern, content, re.IGNORECASE)
                
                for match in matches:
                    open_call = match.group(0)
                    line_num = content[:match.start()].count('\n') + 1
                    
                    # æ£€æŸ¥æ¨¡å¼
                    if '"w"' in open_call or "'w'" in open_call or '"a"' in open_call or "'a'" in open_call or '"r"' in open_call or "'r'" in open_call:
                        # æ–‡æœ¬æ–‡ä»¶æ“ä½œ
                        if 'encoding=' in open_call:
                            if 'encoding="utf-8"' in open_call or "encoding='utf-8'" in open_call:
                                if ('"w"' in open_call or "'w'" in open_call or '"a"' in open_call or "'a'" in open_call) and 'errors=' in open_call:
                                    # æœ€ä½³å®è·µï¼šå†™å…¥/è¿½åŠ æ¨¡å¼æœ‰ errors å‚æ•°
                                    good_practices.append((py_file, line_num, open_call))
                                elif '"r"' in open_call or "'r'" in open_call:
                                    # è¯»å–æ¨¡å¼åªéœ€è¦ encoding
                                    good_practices.append((py_file, line_num, open_call))
                                else:
                                    # å†™å…¥æ¨¡å¼ä½†æ²¡æœ‰ errors å‚æ•°
                                    issues.append((py_file, line_num, open_call, "å†™å…¥æ¨¡å¼ç¼ºå°‘ errors='replace'"))
                            else:
                                # æœ‰ encoding ä½†ä¸æ˜¯ utf-8
                                issues.append((py_file, line_num, open_call, "ç¼–ç ä¸æ˜¯ utf-8"))
                        else:
                            # æ–‡æœ¬æ–‡ä»¶æ“ä½œä½†æ²¡æœ‰ encoding å‚æ•°
                            issues.append((py_file, line_num, open_call, "æ–‡æœ¬æ–‡ä»¶æ“ä½œç¼ºå°‘ encoding å‚æ•°"))
                    elif '"rb"' in open_call or "'rb'" in open_call or '"wb"' in open_call or "'wb'" in open_call:
                        # äºŒè¿›åˆ¶æ–‡ä»¶æ“ä½œï¼Œä¸éœ€è¦ç¼–ç å‚æ•°
                        good_practices.append((py_file, line_num, open_call))
                
            except Exception as e:
                print(f"è¯»å–æ–‡ä»¶ {py_file} æ—¶å‡ºé”™: {e}")
    
    # è¾“å‡ºç»“æœ
    print("\nâœ… ç¬¦åˆè§„èŒƒçš„æ–‡ä»¶æ“ä½œ:")
    print("-" * 40)
    if good_practices:
        for file_path, line_num, open_call in good_practices[:10]:  # åªæ˜¾ç¤ºå‰10ä¸ª
            print(f"{file_path}:{line_num}")
            print(f"  {open_call}")
            print()
    else:
        print("(æ— )")
    
    print("\nâš ï¸ éœ€è¦ä¿®å¤çš„æ–‡ä»¶æ“ä½œ:")
    print("-" * 40)
    if issues:
        for file_path, line_num, open_call, problem in issues:
            print(f"{file_path}:{line_num} - {problem}")
            print(f"  {open_call}")
            print()
    else:
        print("âœ… æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½ç¬¦åˆç¼–ç è§„èŒƒï¼")
    
    return len(issues) == 0

def check_specific_files():
    """æ£€æŸ¥ç‰¹å®šé‡è¦æ–‡ä»¶çš„ç¼–ç è§„èŒƒ"""
    print("\né‡è¦æ–‡ä»¶ç¼–ç è§„èŒƒæ£€æŸ¥")
    print("=" * 60)
    
    important_files = [
        "tools/wake_listener.py",
        "tools/command_router.py",
        "tools/voice_command_handler_integrated.py",
        "tools/unicode_sanitizer.py",
        "start_voice_system.py",
    ]
    
    all_good = True
    
    for file_path in important_files:
        if not os.path.exists(file_path):
            print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
            all_good = False
            continue
            
        try:
            with open(file_path, "r", encoding="utf-8") as f:
                content = f.read()
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æœ¬æ–‡ä»¶å†™å…¥æ“ä½œ
            if 'open(' in content and ('"w"' in content or "'w'" in content or '"a"' in content or "'a'" in content):
                # æ£€æŸ¥æ˜¯å¦æœ‰æ­£ç¡®çš„ç¼–ç è®¾ç½®
                if 'encoding="utf-8"' in content or "encoding='utf-8'" in content:
                    print(f"âœ… {file_path}: åŒ…å«æ­£ç¡®çš„ç¼–ç è®¾ç½®")
                else:
                    print(f"âŒ {file_path}: æ–‡æœ¬æ–‡ä»¶æ“ä½œå¯èƒ½ç¼ºå°‘ç¼–ç è®¾ç½®")
                    all_good = False
            else:
                print(f"âœ… {file_path}: æ— æ–‡æœ¬æ–‡ä»¶å†™å…¥æ“ä½œæˆ–å·²æ­£ç¡®è®¾ç½®")
                
        except Exception as e:
            print(f"âŒ æ£€æŸ¥ {file_path} æ—¶å‡ºé”™: {e}")
            all_good = False
    
    return all_good

def demonstrate_best_practices():
    """æ¼”ç¤ºæœ€ä½³å®è·µ"""
    print("\næ–‡ä»¶ç¼–ç æœ€ä½³å®è·µç¤ºä¾‹")
    print("=" * 60)
    
    examples = [
        ("è¯»å–æ–‡æœ¬æ–‡ä»¶", 'with open("file.txt", "r", encoding="utf-8") as f:\n    content = f.read()'),
        ("å†™å…¥æ–‡æœ¬æ–‡ä»¶", 'with open("file.txt", "w", encoding="utf-8", errors="replace") as f:\n    f.write("å†…å®¹ âœ…ğŸ‰\\n")'),
        ("è¿½åŠ æ–‡æœ¬æ–‡ä»¶", 'with open("file.txt", "a", encoding="utf-8", errors="replace") as f:\n    f.write("è¿½åŠ å†…å®¹\\n")'),
        ("è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶", 'with open("file.bin", "rb") as f:\n    data = f.read()'),
        ("å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶", 'with open("file.bin", "wb") as f:\n    f.write(data)'),
        ("YAMLé…ç½®æ–‡ä»¶", 'import yaml\nwith open("config.yaml", "r", encoding="utf-8") as f:\n    config = yaml.safe_load(f)'),
        ("JSONæ–‡ä»¶", 'import json\nwith open("data.json", "w", encoding="utf-8") as f:\n    json.dump(data, f, ensure_ascii=False, indent=2)'),
    ]
    
    for description, code in examples:
        print(f"{description}:")
        print(code)
        print()
    
    print("å…³é”®è¦ç‚¹:")
    print("  1. æ–‡æœ¬æ–‡ä»¶æ“ä½œå¿…é¡»æŒ‡å®š encoding='utf-8'")
    print("  2. å†™å…¥/è¿½åŠ æ¨¡å¼åº”è¯¥æ·»åŠ  errors='replace'")
    print("  3. äºŒè¿›åˆ¶æ–‡ä»¶æ“ä½œä¸éœ€è¦ç¼–ç å‚æ•°")
    print("  4. ä½¿ç”¨ with è¯­å¥ç¡®ä¿æ–‡ä»¶æ­£ç¡®å…³é—­")

def main():
    """ä¸»æ£€æŸ¥å‡½æ•°"""
    print("æ–‡ä»¶ç¼–ç è§„èŒƒæ£€æŸ¥å·¥å…·")
    print("=" * 60)
    print("ç¡®ä¿æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½éµå¾ªæœ€ä½³å®è·µ:")
    print("  open(..., encoding='utf-8', errors='replace')")
    print()
    
    # è¿è¡Œæ£€æŸ¥
    files_ok = check_file_operations()
    important_ok = check_specific_files()
    
    # æ¼”ç¤ºæœ€ä½³å®è·µ
    demonstrate_best_practices()
    
    print("\n" + "=" * 60)
    print("æ£€æŸ¥ç»“æœæ±‡æ€»:")
    print("=" * 60)
    
    all_ok = files_ok and important_ok
    
    if all_ok:
        print("ğŸ‰ æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½ç¬¦åˆç¼–ç è§„èŒƒï¼")
        print()
        print("ç³»ç»Ÿå·²å®æ–½çš„æœ€ä½³å®è·µ:")
        print("  1. âœ… æ‰€æœ‰æ–‡æœ¬æ–‡ä»¶æ“ä½œæŒ‡å®š encoding='utf-8'")
        print("  2. âœ… å†™å…¥/è¿½åŠ æ¨¡å¼åŒ…å« errors='replace'")
        print("  3. âœ… é‡è¦æ–‡ä»¶éƒ½å·²æ£€æŸ¥é€šè¿‡")
        print("  4. âœ… ç»Ÿä¸€çš„ç¼–ç æ ‡å‡†")
        print()
        print("è¿™ç¡®ä¿äº†:")
        print("  â€¢ ä¸­æ–‡å’Œ Unicode å­—ç¬¦æ­£ç¡®æ˜¾ç¤º")
        print("  â€¢ è·¨å¹³å°å…¼å®¹æ€§")
        print("  â€¢ æ•°æ®å®Œæ•´æ€§")
        print("  â€¢ ç³»ç»Ÿç¨³å®šæ€§")
        return 0
    else:
        print("âš ï¸ å‘ç°éœ€è¦ä¿®å¤çš„æ–‡ä»¶æ“ä½œ")
        print()
        print("å»ºè®®ä¿®å¤:")
        print("  1. ä¸ºæ‰€æœ‰æ–‡æœ¬æ–‡ä»¶æ“ä½œæ·»åŠ  encoding='utf-8'")
        print("  2. ä¸ºå†™å…¥/è¿½åŠ æ¨¡å¼æ·»åŠ  errors='replace'")
        print("  3. è¿è¡Œæ­¤æ£€æŸ¥å·¥å…·éªŒè¯ä¿®å¤")
        return 1

if __name__ == "__main__":
    sys.exit(main())