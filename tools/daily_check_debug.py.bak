import os, json, wave, sys
from datetime import datetime

def file_ok(p, min_size=1):
    return os.path.exists(p) and os.path.getsize(p) >= min_size

def tts_check():
    mp3 = r"logs\tts_test.mp3"
    if file_ok(mp3, 1000):
        return True, mp3, os.path.getsize(mp3)
    return False, mp3, (os.path.getsize(mp3) if os.path.exists(mp3) else 0)

def asr_check_strict():
    from vosk import Model, KaldiRecognizer
    
    model_path = r"C:\Users\A\.openclaw\models\vosk-cn"
    wav_path = r"logs\voice_16k_resampled.wav"
    
    if not os.path.isdir(model_path):
        return False, "model_missing", ""
    
    if not file_ok(wav_path, 1000):
        return False, "wav_missing", ""
    
    wf = wave.open(wav_path, "rb")
    model = Model(model_path)
    rec = KaldiRecognizer(model, wf.getframerate())
    
    texts = []
    while True:
        data = wf.readframes(4000)
        if len(data) == 0:
            break
        if rec.AcceptWaveform(data):
            texts.append(json.loads(rec.Result()).get("text",""))
    
    texts.append(json.loads(rec.FinalResult()).get("text",""))
    text = " ".join([t for t in texts if t]).strip()
    
    # === 断言 C（最严格）===
    # 必须同时出现 "小九" + "语音识别"
    # 注意：Vosk 可能输出 "语音 识别"（中间有空格），所以这里也兼容
    print("DEBUG: 识别文本:", repr(text))
    has_xiaojiu = ("小九" in text)
    print("DEBUG: has_xiaojiu (小九 in text):", has_xiaojiu)
    
    has_yuyinshibie = ("语音识别" in text) or (("语音" in text) and ("识别" in text))
    print("DEBUG: has_yuyinshibie:")
    print("DEBUG:   '语音识别' in text:", "语音识别" in text)
    print("DEBUG:   '语音' in text:", "语音" in text)
    print("DEBUG:   '识别' in text:", "识别" in text)
    print("DEBUG:   has_yuyinshibie:", has_yuyinshibie)
    
    ok = has_xiaojiu and has_yuyinshibie
    print("DEBUG: ok (has_xiaojiu AND has_yuyinshibie):", ok)
    
    return ok, wav_path, text

def main():
    tts_ok, tts_path, tts_size = tts_check()
    asr_ok, asr_path, asr_text = asr_check_strict()
    
    tts_str = "OK" if tts_ok else "FAIL"
    asr_str = "OK" if asr_ok else "FAIL"
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # 一行摘要
    print(f"daily_check | ASR={asr_str} TTS={tts_str} | tts={tts_size}B | asr_text=\"{asr_text[:80]}\" | {now}")
    
    # 详细信息
    print("DETAIL:")
    print(" TTS:", tts_str, tts_path, tts_size)
    print(" ASR:", asr_str, asr_path)
    print(" ASR_TEXT:", asr_text if asr_text else "(empty)")
    
    sys.exit(0 if (tts_ok and asr_ok) else 2)

if __name__ == "__main__":
    main()
